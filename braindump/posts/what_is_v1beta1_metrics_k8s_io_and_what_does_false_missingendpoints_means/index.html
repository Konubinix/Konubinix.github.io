<!DOCTYPE html>
<html><title>what is v1beta1.metrics.k8s.io and what does False (MissingEndpoints) means</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="bLmaFyyXugiCqSup-eIIIx0B4CngtdF_svyMMKQbS5E" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10, minimum-scale=0.5, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes" />
<script src="https://hypothes.is/embed.js" async></script>


<link rel="stylesheet" href="/braindump/css/main.min.56b43bcbc759a196f9dd525bee62bdec45a29ba95902bbab74a4f7ad2ea3e8cb.css"/>

<link rel="stylesheet" href="/braindump/css/links.min.4bf1990b213fb76d2a66153dc6ef9a57d49f536c6baf6e7f19a7948470a38141.css"/>

<link rel="stylesheet" href="/braindump/css/konubinix.min.cf2d0f36945178c647979ee68f1830892e06aa3d481d8913728b5c7462b97f6e.css"/>

<link rel="stylesheet" href="/ipfs/QmQFVQS89fv1XUNFcjwCKDePzckuT9kpuAVNYUwNdEfYcv/css/all.css"/>
<link rel="shortcut icon" href="/ipfs/QmVFwYV7YRZLKU3ybN1hW4jqfyZGPLKJwd8toN2wHz5UAD?a.png" type="image/x-icon" />

<body><header>
  <div>
	<a href="/braindump//"><h5 class="site-title">Konubinix&#39; opinionated web of thoughts</h5></a>
  </div>
  <span>
	<a href="/blog/"><i class="icon fas fa-blog"></i></a>
	<a href="/braindump/posts/"><i class="icon fas fa-brain"></i></a>
    <a href="mailto:konubinixweb@gmail.com"><i class="icon fas fa-envelope-square"></i></a>
    <a href="https://github.com/konubinix"><i class="icon fab fa-github-square"></i></a>
    <a href="https://linkedin.com/in/samuel-loury-61259040"><i class="icon fab fa-linkedin"></i></a>
	<a href="/braindump/graph.html"><i class="icon fas fa-project-diagram"></i></a>
	<a href="/braindump/index.xml"><i class="icon fas fa-rss-square"></i></a>
	<a href="/braindump/tags/"><i class="icon fa fa-tag"></i></a>
	<a href="/braindump/braindump_search"><i class="icon fa fa-search"></i></a>
  </span>
</header>

<div class="grid-container">
  <div class="grid">
    <div class="page" data-level="1">
      <div class="content">
		<p class="lead">
        <h1>What Is V1beta1.metrics.k8s.io and What Does False (MissingEndpoints) Means</h1>
		<span class="badge badge-pill badge-warning"><a href="/braindump/tags/fleeting/">Fleeting</a></span></p>
        <p>what is <a href="/braindump/posts/kubernetes_metrics/">v1beta1.metrics.k8s.io</a> and what does False (MissingEndpoints) means
<a href="/braindump/posts/kubernetes/">kubernetes</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl create namespace testns
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>namespace/testns created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl delete namespaces testns
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>namespace &#34;testns&#34; deleted
</span></span></code></pre></div><p>but hanging&hellip;</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl describe namespace testns
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Name:         testns
</span></span><span style="display:flex;"><span>Labels:       kubernetes.io/metadata.name=testns
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Status:       Terminating
</span></span><span style="display:flex;"><span>Conditions:
</span></span><span style="display:flex;"><span>  Type                                         Status  LastTransitionTime               Reason                  Message
</span></span><span style="display:flex;"><span>  ----                                         ------  ------------------               ------                  -------
</span></span><span style="display:flex;"><span>  NamespaceDeletionDiscoveryFailure            True    Mon, 14 Nov 2022 14:39:09 +0100  DiscoveryFailed         Discovery failed for some groups, 1 failing: unable to retrieve the complete list of server APIs: metrics.k8s.io/v1beta1: the server is currently unable to handle the request
</span></span><span style="display:flex;"><span>  NamespaceDeletionGroupVersionParsingFailure  False   Mon, 14 Nov 2022 14:39:09 +0100  ParsedGroupVersions     All legacy kube types successfully parsed
</span></span><span style="display:flex;"><span>  NamespaceDeletionContentFailure              False   Mon, 14 Nov 2022 14:39:09 +0100  ContentDeleted          All content successfully deleted, may be waiting on finalization
</span></span><span style="display:flex;"><span>  NamespaceContentRemaining                    False   Mon, 14 Nov 2022 14:39:09 +0100  ContentRemoved          All content successfully removed
</span></span><span style="display:flex;"><span>  NamespaceFinalizersRemaining                 False   Mon, 14 Nov 2022 14:39:09 +0100  ContentHasNoFinalizers  All content-preserving finalizers finished
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>No resource quota.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>No LimitRange resource.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl get apiservices.apiregistration.k8s.io v1beta1.metrics.k8s.io
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>NAME                     SERVICE                      AVAILABLE                  AGE
</span></span><span style="display:flex;"><span>v1beta1.metrics.k8s.io   kube-system/metrics-server   False (MissingEndpoints)   4d20h
</span></span></code></pre></div><blockquote>
<p>It seems to have been a problem with resources, I only had one node in the
cluster with only 4GB memory and 2 vCPU, after scale problem solved. Thanks.</p>
<p>&mdash; <a href="https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/167">https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/167</a></p>
</blockquote>
<p>There is indeed a metric-server running in this cluster.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl get -n kube-system deployment metrics-server
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>NAME             READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>metrics-server   0/1     1            0           4d21h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl describe -n kube-system deployment metrics-server|sed -n <span style="color:#d14">&#39;/Condition/,/^[^ ]/p&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Conditions:
</span></span><span style="display:flex;"><span>  Type           Status  Reason
</span></span><span style="display:flex;"><span>  ----           ------  ------
</span></span><span style="display:flex;"><span>  Available      False   MinimumReplicasUnavailable
</span></span><span style="display:flex;"><span>  Progressing    False   ProgressDeadlineExceeded
</span></span><span style="display:flex;"><span>OldReplicaSets:  &lt;none&gt;
</span></span></code></pre></div><p>The associated pod failed to be ready.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl get pod -n kube-system metrics-server-ff9dbcb6c-qgr4c
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>metrics-server-ff9dbcb6c-qgr4c   0/1     Running   0          4d21h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl -n kube-system describe pod metrics-server-ff9dbcb6c-qgr4c|sed -n <span style="color:#d14">&#39;/Events/,$p&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason     Age                         From     Message
</span></span><span style="display:flex;"><span>  ----     ------     ----                        ----     -------
</span></span><span style="display:flex;"><span>  Warning  Unhealthy  3m14s (x210750 over 4d21h)  kubelet  Readiness probe failed: HTTP probe failed with statuscode: 500
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl -n kube-system logs metrics-server-ff9dbcb6c-qgr4c|head -n <span style="color:#099">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>E1114 10:11:35.797461       1 scraper.go:139] &#34;Failed to scrape node&#34; err=&#34;Get \&#34;https://XXXXXXX/stats/summary?only_cpu_and_memory=true\&#34;: x509: certificate is valid for 127.0.0.1, YYYYYYYYYYY, not XXXXXXXXX&#34; node=&#34;ZZZZZZZZZZZ&#34;
</span></span></code></pre></div><p>The node has a certificate that works for localhost and its public address, but not its private address.</p>
<p>It looks like this advice might work.</p>
<blockquote>
<p>Simply run:</p>
<p>kubectl patch deployment metrics-server -n kube-system &ndash;type &lsquo;json&rsquo; -p &lsquo;[{&ldquo;op&rdquo;: &ldquo;add&rdquo;, &ldquo;path&rdquo;: &ldquo;<em>spec/template/spec/containers/0/args</em>-&rdquo;, &ldquo;value&rdquo;: &ldquo;&ndash;kubelet-insecure-tls&rdquo;}]&rsquo;
Make sure to adjust the namespace accordingly, e.g. default or kube-system</p>
<p>&mdash; <a href="https://github.com/kubernetes-sigs/metrics-server/issues/525">https://github.com/kubernetes-sigs/metrics-server/issues/525</a></p>
</blockquote>
<p>It would be good to check whether we could simply use the http connection rather
than the https one, instead of artificially ask to be insecure.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl <span style="color:#0086b3">exec</span> -t -i -n kube-system metrics-server-ff9dbcb6c-qgr4c -- sh
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>error: Internal error occurred: error executing command in container: failed to exec in container: failed to start exec &#34;a3422eeac47b032cfcd6631f6b27cd95831278c4839ceea57156f81d382e84be&#34;: OCI runtime exec failed: exec failed: container_linux.go:380: starting container process caused: exec: &#34;ls&#34;: executable file not found in $PATH: unknown
</span></span></code></pre></div><p>Tried with bash, sh and even ls.</p>
<p>Chances are this is a <a href="/braindump/posts/distroless/">distroless</a> image.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl get -n kube-system pod metrics-server-ff9dbcb6c-qgr4c --output json|jq <span style="color:#d14">&#39;.spec.containers[0].image&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&#34;rancher/mirrored-metrics-server:v0.5.2&#34;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>clk docker image show-rootfs rancher/mirrored-metrics-server:v0.5.2|gi bin/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bin/
</span></span><span style="display:flex;"><span>sbin/
</span></span><span style="display:flex;"><span>usr/bin/
</span></span><span style="display:flex;"><span>usr/sbin/
</span></span><span style="display:flex;"><span>usr/sbin/tzconfig
</span></span></code></pre></div><p>Indeed, it contains no binary, but metric-server.</p>
<p>Its a good opportunity to try <a href="/braindump/posts/debug_containers/">debug containers</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl -n kube-system  debug metrics-server-ff9dbcb6c-qgr4c -ti --image<span style="color:#000;font-weight:bold">=</span>busybox
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>error: ephemeral containers are disabled for this cluster (error from server: &#34;the server could not find the requested resource&#34;).
</span></span></code></pre></div><p>Well, it was worth trying.</p>
<p>Let&rsquo;s create another pod then.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl -n kube-system create deployment --image<span style="color:#000;font-weight:bold">=</span>alpine debug -- sleep <span style="color:#099">3600</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>deployment.apps/debug created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>$ ktl exec -t -i -n kube-system debug-789bb8d684-c5kwc -- sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># apk add curl
</span></span><span style="display:flex;"><span># curl -k http://XXXXXXXX:10250/stats/summary?only_cpu_and_memory=true
</span></span><span style="display:flex;"><span>Unauthorized
</span></span><span style="display:flex;"><span># curl -k http://XXXXXXXX:10250/stats/summary?only_cpu_and_memory=true
</span></span><span style="display:flex;"><span>Client sent an HTTP request to an HTTPS server.
</span></span></code></pre></div><p>Well, now, that sounds silly. I should try to find the equivalent http
port. Actually I find out that <a href="/braindump/posts/ports_and_protocols_kubernetes/#port-10250-in-id-963f90ee-c92c-4c51-bf17-cbd8b7af0408-kubernetes-self">port 10250 in kubernetes == self</a> and there is no
http equivalent.</p>
<p>I can either accept the « insecure » solution or try to find out how to have the
cluster run with the certificate of the nodes handling the private ip address.</p>
<p>It is a <a href="/braindump/posts/hetzner/">hetzner</a> cloud, setup with the hcloud <a href="/braindump/posts/terraform/">terraform</a> provider.  I should
try to look at this to see whether there is an option.</p>
<p>I guess this is dealt with by
<a href="https://github.com/hetznercloud/hcloud-cloud-controller-manager">https://github.com/hetznercloud/hcloud-cloud-controller-manager</a>, but I could not
find any option about the private ip of the nodes in the private network.</p>
<p>Somehow, the installation of <a href="/braindump/posts/k3s/">k3s</a> only creates a certificates for the node
external ip but not the node internal ip. But somehow the metrics it creates
uses the internalip and not the externalip.</p>
<p>Another lead is to make the metric server use the public ip, the one for which
the certificate is actually released.</p>
<p>Let&rsquo;s take a break and summarize what I know so far.</p>
<ul>
<li>our hcloud setup installs <a href="/braindump/posts/k3s/">k3s</a> on the nodes, without disabling the metric server</li>
<li>we use a private network, set as InternalIP by the hcloud cloud manager</li>
<li>but the hcloud cloud manager generates a certificates that is only valid for the ExternalIP</li>
</ul>
<p>It seems that the <a href="/braindump/posts/metrics_server/">metric server</a> deployed by k3s is the official ones<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. At least
the command line seems the same.</p>
<p>Trying with <a href="/braindump/posts/metrics_server/#9b8308d9-7dee-4522-9b1a-7eef337fed03">kubelet-preferred-address-types</a>, I changed the deployment to use
only the external ip address (using &ndash;kubelet-preferred-address-types=ExternalIP).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl -n kube-system logs metrics-server-7cfcd7bb46-fhjfn | gi scrape
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>E1114 16:18:17.167019       1 scraper.go:139] &#34;Failed to scrape node&#34; err=&#34;Get \&#34;https://YYYYYYY:10250/stats/summary?only_cpu_and_memory=true\&#34;: context deadline exceeded&#34; node=&#34;ZZZZZZZZZZZZZ&#34;
</span></span></code></pre></div><p>The IP is indeed the external one, but the node does not actually seem to listen
to those ip addresses, leading to a timeout.</p>
<p>Trying to put back but
adding <a href="/braindump/posts/metrics_server/#482e2efa-7997-491f-ac34-ded923065a6c">kubelet-insecure-tls</a>, there is no error and the pod finally gets ready.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl -n kube-system get pod metrics-server-55cb6f95b5-8n2fn
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>metrics-server-55cb6f95b5-8n2fn   1/1     Running   0          83s
</span></span></code></pre></div><p>The API finally gets ready</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl get apiservices.apiregistration.k8s.io v1beta1.metrics.k8s.io
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>NAME                     SERVICE                      AVAILABLE   AGE
</span></span><span style="display:flex;"><span>v1beta1.metrics.k8s.io   kube-system/metrics-server   True        4d23h
</span></span></code></pre></div><p>And my namespace can be deleted once and for all.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ktl get namespace testns
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Error from server (NotFound): namespaces &#34;testns&#34; not found
</span></span></code></pre></div><p>That is not ideal, as this should be for testing purpose only.</p>
<p>Let&rsquo;s see anyway how to persist this configuration.</p>
<p>The <a href="https://github.com/k3s-io/k3s/blob/master/manifests/metrics-server/metrics-server-deployment.yaml#L46">manifest installing the metric server</a> provides a way to change the
<a href="/braindump/posts/metrics_server/#9b8308d9-7dee-4522-9b1a-7eef337fed03">kubelet-preferred-address-types</a>, but not to add the &ndash;kubelet-insecure-tls
flag. Actually, I cannot find kubelet-insecure-tls anywhere in the source code
of k3s.</p>
<p>Therefore I see no choice but to patch the deployment afterwards, using:</p>
<blockquote>
<p>Simply run:</p>
<p>kubectl patch deployment metrics-server -n kube-system &ndash;type &lsquo;json&rsquo; -p &lsquo;[{&ldquo;op&rdquo;: &ldquo;add&rdquo;, &ldquo;path&rdquo;: &ldquo;<em>spec/template/spec/containers/0/args</em>-&rdquo;, &ldquo;value&rdquo;: &ldquo;&ndash;kubelet-insecure-tls&rdquo;}]&rsquo;
Make sure to adjust the namespace accordingly, e.g. default or kube-system</p>
<p>&mdash; <a href="https://github.com/kubernetes-sigs/metrics-server/issues/525">https://github.com/kubernetes-sigs/metrics-server/issues/525</a></p>
</blockquote>
<p>Now, let&rsquo;s try to have a more elegant solution, that would not require to patch
a deployment created by k3s.</p>
<p>I need to find a way to inform the <a href="/braindump/posts/cloud_controller_manager/">CCM</a> that the kubelet running on the nodes should be signed using its <a href="/braindump/posts/internalip/">InternalIP</a>, at least using a <a href="/braindump/posts/subject_alternative_name/">SANs</a>.</p>
<p>Connecting to the node I can run
of</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>openssl x509  -noout -text -in /var/lib/rancher/k3s/agent/serving-kubelet.crt |grep Alternative -A1
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>X509v3 Subject Alternative Name:
</span></span><span style="display:flex;"><span>   DNS:NAME, DNS:localhost, IP Address:127.0.0.1, IP Address:&lt;ExternalIP&gt;
</span></span></code></pre></div><p>I can try using the &ndash;tls-san option of k3s</p>
<p>But I still need to have a way to know the internal ip to set it.</p>
<p>Knowing that I configured the internal ip to use the <a href="/braindump/posts/classless_inter_domain_routing/">ip range</a> 10.0.0.0/24 I can craft something like</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ip a|grep 10.0.0|sed -r <span style="color:#d14">&#39;s/^.+(10.0.0.[0-9]+).+$/\1/&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>10.0.0.4
</span></span></code></pre></div><p>That could be run prior to run k3s in the nodes.</p>
<h2 id="permalink"><a href="https://konubinix.eu/braindump/1798784e-e9d4-414b-aabf-a72faa3ca457?title=what_is_v1beta1_metrics_k8s_io_and_what_does_false_missingendpoints_means">Permalink</a></h2>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>looking at the <a href="https://hub.docker.com/layers/rancher/mirrored-metrics-server/v0.5.0/images/sha256-df686e9837739a0db05ea4f4e62098a8300ba31d2d9914a63049dac626bf187d?context=explore#!">layers</a> we can see it basically gets the binary built from the <a href="/braindump/posts/metrics_server/">metrics-server</a>.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
      </div>
	  <aside class="date"><time>Last updated: 15 Nov 2022</time></aside>
	  <aside class="date"><time>Published&nbsp;&nbsp;&nbsp;: 14 Nov 2022</time></aside>
    </div>
  </div>
</div>

<script src="/braindump/js/URI.js" type="text/javascript"></script>

<script src="/braindump/js/page.js" type="text/javascript"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>
