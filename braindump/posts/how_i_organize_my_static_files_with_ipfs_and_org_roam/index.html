<!DOCTYPE html>
<html><title>how I organize my static files with IPFS and org-roam</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="bLmaFyyXugiCqSup-eIIIx0B4CngtdF_svyMMKQbS5E" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10, minimum-scale=0.5, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes" />
<script src="https://hypothes.is/embed.js" async></script>


<link rel="stylesheet" href="/braindump/css/main.min.56b43bcbc759a196f9dd525bee62bdec45a29ba95902bbab74a4f7ad2ea3e8cb.css"/>

<link rel="stylesheet" href="/braindump/css/links.min.4bf1990b213fb76d2a66153dc6ef9a57d49f536c6baf6e7f19a7948470a38141.css"/>

<link rel="stylesheet" href="/braindump/css/konubinix.min.cf2d0f36945178c647979ee68f1830892e06aa3d481d8913728b5c7462b97f6e.css"/>

<link rel="stylesheet" href="/ipfs/QmQFVQS89fv1XUNFcjwCKDePzckuT9kpuAVNYUwNdEfYcv/css/all.css"/>
<link rel="shortcut icon" href="/ipfs/QmVFwYV7YRZLKU3ybN1hW4jqfyZGPLKJwd8toN2wHz5UAD?a.png" type="image/x-icon" />

<body><header>
  <div>
	<a href="/braindump//"><h5 class="site-title">Konubinix&#39; opinionated web of thoughts</h5></a>
  </div>
  <span>
	<a href="/blog/"><i class="icon fas fa-blog"></i></a>
	<a href="/braindump/posts/"><i class="icon fas fa-brain"></i></a>
    <a href="mailto:konubinixweb@gmail.com"><i class="icon fas fa-envelope-square"></i></a>
    <a href="https://github.com/konubinix"><i class="icon fab fa-github-square"></i></a>
    <a href="https://linkedin.com/in/samuel-loury-61259040"><i class="icon fab fa-linkedin"></i></a>
	<a href="/braindump/graph.html"><i class="icon fas fa-project-diagram"></i></a>
	<a href="/braindump/index.xml"><i class="icon fas fa-rss-square"></i></a>
	<a href="/braindump/tags/"><i class="icon fa fa-tag"></i></a>
	<a href="/braindump/braindump_search"><i class="icon fa fa-search"></i></a>
  </span>
</header>

<div class="grid-container">
  <div class="grid">
    <div class="page" data-level="1">
      <div class="content">
		<p class="lead">
        <h1>How I Organize My Static Files With IPFS and Org-Roam</h1>
		<span class="badge badge-pill badge-warning"><a href="/braindump/tags/fleeting/">Fleeting</a></span></p>
        <div class="ox-hugo-toc toc">
<div class="heading">Table of Contents</div>
<ul>
<li><a href="#my-problem">my problem</a></li>
<li><a href="#zettelkasten--zettelkasten-dot-md--to-the-rescue">zettelkasten to the rescue</a></li>
<li><a href="#my-new-workflow">my new workflow</a></li>
<li><a href="#how-to-store-those-files">how to store those files</a>
<ul>
<li><a href="#the-stack">the stack</a></li>
<li><a href="#the-workflow-of-the-ipfs-companions">the workflow of the ipfs companions</a></li>
<li><a href="#the-tooling">the tooling</a></li>
<li><a href="#likecycle-of-the-data-and-backup">likecycle of the data and backup</a></li>
</ul>
</li>
<li><a href="#conclusion">conclusion</a></li>
<li><a href="#notes-linking-here">Notes linking here</a></li>
<li><a href="#permalink">Permalink</a></li>
</ul>
</div>
<!--endtoc-->
<ul>
<li>see,
<ul>
<li><a href="/braindump/posts/ideal_file_system/">ideal file system</a>,</li>
<li><a href="/braindump/posts/my_stack/">my stack</a>,</li>
<li><a href="/braindump/posts/zettelkasten/">zettelkasten</a>,</li>
<li><a href="/braindump/posts/ipfs/">ipfs</a>,</li>
<li><a href="https://konubinix.eu/blog/posts/how_do_i_store_my_files/?title=how_do_i_store_my_files#">how do I store my files?</a>,</li>
</ul>
</li>
</ul>
<h2 id="my-problem">my problem</h2>
<p>Traditionally, when we store a file, there is a central question that we ask
ourselves: where do I put the file?</p>
<p>I seldom find satisfying answers to this question using the classical folder
hierarchy. Also, when I need the file in the future, I generally have a hard
time finding it, because my mindset changed in the mean time.</p>
<p>Imagine I want to keep some file, like <a href="/braindump/posts/my_emoji/">my emoji</a>. In that traditional state of
mind, I would put the data in some hard drive in a location that would make
sense at the time. Something like &ldquo;personal/identity/emoji.jpg&rdquo;.</p>
<h2 id="zettelkasten--zettelkasten-dot-md--to-the-rescue"><a href="/braindump/posts/zettelkasten/">zettelkasten</a> to the rescue</h2>
<p>I&rsquo;ve always wanted to remove the burden of finding a path. I was quite convinced
by tools like git or ipfs, with a content addressable state of mind. But I did
not have a satisfying way to index those files.</p>
<p>Then, I discovered <a href="/braindump/posts/org_roam/">org-roam</a> that provides a way to curate a <a href="/braindump/posts/trusted_system/">second brain</a>, a
<a href="/braindump/posts/communicating_with_slip_boxes_by_niklas_luhmann/">conversation partner</a> that helps me get back old thoughts when I need them.</p>
<p>Why stop here and just retrieve old thoughts? Why not also use my conversation
partner to dig out files I have put in it.</p>
<h2 id="my-new-workflow">my new workflow</h2>
<p>Then, my workflow is:</p>
<ol>
<li>realize I need to store a file,</li>
<li>decide what this file means. What is the concept that this file makes concrete,</li>
<li>ipfs add the file,</li>
<li>provide this hash to my <a href="/braindump/posts/communicating_with_slip_boxes_by_niklas_luhmann/">conversation partner</a>, like I put any other
<a href="/braindump/posts/zettel/">zettel</a>,</li>
<li>forget about it.</li>
</ol>
<p>If I need to get the file back, I trust my <a href="/braindump/posts/communicating_with_slip_boxes_by_niklas_luhmann/">conversation partner</a> for showing my
the appropriate note when the time comes. That means that when I want the file
back, I don&rsquo;t have to think in file hierarchy, but I can just look for whatever
comes to mind and let the network of thoughts naturally lead me to my file.</p>
<p>For instance, if I want to get back to <a href="/braindump/posts/my_emoji/">my emoji</a>, I may ask myself &ldquo;where is the
image I use in <a href="/braindump/posts/my_cv/">my cv</a>?&rdquo;. In that case, I just go to <a href="/braindump/posts/my_cv/">my CV</a> and quickly find <a href="/braindump/posts/my_emoji/">my
emoji</a>.</p>
<h2 id="how-to-store-those-files">how to store those files</h2>
<p>To do so, the system needs to be able to store files in addition to simply store
notes.</p>
<h3 id="the-stack">the stack</h3>
<p>To deal with this, I created a private cluster of ipfs nodes<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. Because
<a href="/braindump/posts/ipfs_pinning_sucks/">ipfs pinning sucks</a>, and because I only have a central index of CIDs, I also
have a <a href="/braindump/posts/postgresql/">postgresql</a> database to store those CIDs.</p>
<p>I also have an ipfs companion program per ipfs node that runs `ipfs
get`, ensuring that the node has the content it is supposed to have. There is
also an ipfs controller whose role is to find CIDs not yet allocated and ask the
ipfs companions to ensure the nodes have downloaded them.</p>
<p>To make the ipfs companions and the controller discuss and store a temporary
state of what files to get, I also have an instance of <a href="/braindump/posts/redis/">redis</a> running.</p>
<p>Finally, my laptop runs also an ipfs node connected to the cluster, allowing
me to ipfs add locally.</p>
<h3 id="the-workflow-of-the-ipfs-companions">the workflow of the ipfs companions</h3>
<p>The ipfs companions keep up-to-date a redis value of the remaining disk space.</p>
<p>The ipfs controller, at regular intervals, finds in postgresql what CIDs have
not been replicated yet, decides what companion should store the CID based on
the remaining space, then order via redis the companions to get the
appropriate files and finally update the <a href="/braindump/posts/postgresql/">postgresql</a> database to indicate what
companion owns which CID.</p>
<p>Its code can be seen in <a href="https://github.com/Konubinix/ipfsworker">here</a>. It is not made to be usable by other people
than me (yet?), but I published it anyway because people kept asking to get a
look at it.</p>
<h3 id="the-tooling">the tooling</h3>
<p>Also, I made a script that</p>
<ol>
<li>extract all the CIDs from places of interest (like my <a href="/braindump/posts/zettelkasten/">zettelkasten</a>),</li>
<li>add missing CIDs in postgresql,</li>
<li>remove extra CIDs from postgresql,</li>
</ol>
<p>At first, the CID are only added in the ipfs node that runs in my
laptop. Then, when the postgresql database is updated, the ipfs controller
duplicate those in the ipfs nodes.</p>
<p>From time to time, I also have a script that consult the ipfs controller and
the ipfs companion to check whether the sync is done.</p>
<p>The sync script is run a lot during the day, like every time I publish a new
version of my <a href="/braindump/posts/the_brain_of_konubinix/">braindump</a> or my <a href="https://konubinix.eu/blog/posts/the_blog_of_konubinix/?title=the_blog_of_konubinix#">blog</a><sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<h3 id="likecycle-of-the-data-and-backup">likecycle of the data and backup</h3>
<p>The ipfs controller makes sure that at least two nodes store each CID, making
the system resilient to the possible crash of one disk.</p>
<p>Garbage collecting old files is a side effect of me practicing <a href="/braindump/posts/manual_progressive_chaos_monkey/">manual
progressive chaos monkey</a>. From time to time I replace a hard drive with an
empty one. Because the controller allocated each CID to at least two nodes,
then the system realizes there are bunch of files that are to be duplicated
again. It does the work of asking another node to keep a new copy.</p>
<p>Now, the last part of the system is about backups. I have an external drive
that receives weekly a copy of all the CIDs stored in postgresql. It puts
them in a multi layered directories<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>. Then, using an encrypted <a href="/braindump/posts/borgbackup/">borg</a>, I
create a remote backup of my backup on the drive of a friend that lives in
another country.</p>
<p>Therefore, to loose some file, it means that</p>
<ul>
<li>either my computer crashed before the sync happens,</li>
<li>or the same thing<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> + at least two nodes crash during the week of adding
the file without me noticing (or quickly enough for me not to have time to
deal with the crashes),</li>
<li>or the same thing + my external backup and my friend encrypted copy crash
quickly enough for me not to be able to fix them,</li>
</ul>
<p>Well, I feel pretty good about the persistence of my data.</p>
<h2 id="conclusion">conclusion</h2>
<p>Now, with all that in place, here is the complete workflow to add a file:</p>
<ol>
<li>I need to save a file,</li>
<li>I ipfs add it,</li>
<li>Put the CID in some sensible note,</li>
<li>then, the system deals with replicating the file, so that I don&rsquo;t have to
bother thinking about it again.</li>
</ol>
<p>And the workflow to retrieve a file:</p>
<ol>
<li>I ask the system,</li>
<li>I get the note,</li>
<li>I open the file,</li>
</ol>
<p>Notice that the part of the flow where I actually use cognitive energy is very
small (<a href="/braindump/posts/sofa/">EAST</a>). In the end, I just add a file where it naturally belong and
let the system deal with the rest.</p>
<p>I have made the system such as it leans on some habits I must have, like
running the sync script. This <a href="/braindump/posts/semi_automated_system/">semi automated system</a> is my personal way
of dealing with automation.</p>
<h2 id="notes-linking-here">Notes linking here</h2>
<ul>
<li><a href="/braindump/posts/comment_je_reference_mes_fichiers/">comment je référence mes fichiers</a></li>
<li><a href="https://konubinix.eu/blog/posts/how_do_i_store_my_files/?title=how_do_i_store_my_files#">how do I store my files?</a> (blog)</li>
<li><a href="/braindump/posts/ideal_file_system/">ideal file system</a></li>
<li><a href="/braindump/posts/inverse_la_dependance_aux_fichiers/">inverse la dépendance aux fichiers</a></li>
<li><a href="/braindump/posts/ipfs/">ipfs</a></li>
<li><a href="/braindump/posts/literate_data_storage/">literate data storage</a></li>
<li><a href="/braindump/posts/my_stack/">my stack</a></li>
<li><a href="/braindump/posts/org_roam/">org-roam</a></li>
</ul>
<h2 id="permalink"><a href="https://konubinix.eu/braindump/63b193f7-84d8-4ee0-8cb5-61146efd9703?title=how_i_organize_my_static_files_with_ipfs_and_org_roam">Permalink</a></h2>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>I could have created any system that provides content addressable
addresses. Ipfs shines in the way it works well on <a href="/braindump/posts/raspberry_pi/">raspberry pi</a>, it is
meant to work in cluster so that I can easily add a node to add space and
redundancy.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Actually, not only does it sync my CIDs with postgresql, but it also wait for
the CIDs to be replicated before actually publish, so that I can poweroff my
laptop without the risk of having a note referring to some unavailable file that
would have only one copy (in my off laptop),&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><code>${hash:0:5}/${hash:5:3}/${hash:8:3}/${hash:11:3}/${hash:14}</code></p>
<!--more-->
&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></li>
<li id="fn:4">
<p>I run <code>ipfs repo gc</code> on my laptop only after a successful backup&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
      </div>
	  <aside class="date"><time>Last updated: 11 May 2023</time></aside>
	  <aside class="date"><time>Published&nbsp;&nbsp;&nbsp;: 08 Jun 2022</time></aside>
    </div>
  </div>
</div>

<script src="/braindump/js/URI.js" type="text/javascript"></script>

<script src="/braindump/js/page.js" type="text/javascript"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>
