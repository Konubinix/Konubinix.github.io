<!DOCTYPE html>
<html><title>postgresql</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="bLmaFyyXugiCqSup-eIIIx0B4CngtdF_svyMMKQbS5E" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10, minimum-scale=0.5, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes" />
<script src="https://hypothes.is/embed.js" async></script>


<link rel="stylesheet" href="/braindump/css/main.min.56b43bcbc759a196f9dd525bee62bdec45a29ba95902bbab74a4f7ad2ea3e8cb.css"/>

<link rel="stylesheet" href="/braindump/css/links.min.4bf1990b213fb76d2a66153dc6ef9a57d49f536c6baf6e7f19a7948470a38141.css"/>

<link rel="stylesheet" href="/braindump/css/konubinix.min.cf2d0f36945178c647979ee68f1830892e06aa3d481d8913728b5c7462b97f6e.css"/>

<link rel="stylesheet" href="/ipfs/QmQFVQS89fv1XUNFcjwCKDePzckuT9kpuAVNYUwNdEfYcv/css/all.css"/>
<link rel="shortcut icon" href="/ipfs/QmVFwYV7YRZLKU3ybN1hW4jqfyZGPLKJwd8toN2wHz5UAD?a.png" type="image/x-icon" />

<body><header>
  <div>
	<a href="/braindump//"><h5 class="site-title">Konubinix&#39; opinionated web of thoughts</h5></a>
  </div>
  <span>
	<a href="/blog/"><i class="icon fas fa-blog"></i></a>
	<a href="/braindump/posts/"><i class="icon fas fa-brain"></i></a>
    <a href="mailto:konubinixweb@gmail.com"><i class="icon fas fa-envelope-square"></i></a>
    <a href="https://github.com/konubinix"><i class="icon fab fa-github-square"></i></a>
    <a href="https://linkedin.com/in/samuel-loury-61259040"><i class="icon fab fa-linkedin"></i></a>
	<a href="/braindump/graph.html"><i class="icon fas fa-project-diagram"></i></a>
	<a href="/braindump/index.xml"><i class="icon fas fa-rss-square"></i></a>
	<a href="/braindump/tags/"><i class="icon fa fa-tag"></i></a>
	<a href="/braindump/braindump_search"><i class="icon fa fa-search"></i></a>
  </span>
</header>

<div class="grid-container">
  <div class="grid">
    <div class="page" data-level="1">
      <div class="content">
		<p class="lead">
        <h1>Postgresql</h1>
		<span class="badge badge-pill badge-warning"><a href="/braindump/tags/fleeting/">Fleeting</a></span></p>
        <h2 id="6cd64e15-175f-44da-8d9a-e7e327868bfa">inheritance</h2>
<ul>
<li>Référence externe : <a href="https://www.postgresql.org/docs/current/ddl-inherit.html#DDL-INHERIT-CAVEATS">https://www.postgresql.org/docs/current/ddl-inherit.html#DDL-INHERIT-CAVEATS</a></li>
</ul>
<blockquote>
<p>Other types of constraints (unique, primary key, and foreign key constraints) are not inherited.</p>
<p>&mdash; <a href="https://www.postgresql.org/docs/current/ddl-inherit.html#DDL-INHERIT-CAVEATS">https://www.postgresql.org/docs/current/ddl-inherit.html#DDL-INHERIT-CAVEATS</a></p>
</blockquote>
<h2 id="36e3bc26-94ae-4a9f-b7ed-57ba7b923c7c">with bitnami</h2>
<h3 id="79c99355-2a0d-4782-8238-dbc4552c0447">bitnami ne se configure pas bien</h3>
<p><a href="/braindump/posts/bitnami/">bitnami</a> ne se configure pas bien sur <a href="/braindump/posts/kubernetes/">k8s</a> avec <a href="/braindump/posts/keycloak/">keycloak</a></p>
<p>Sur un cluster tout frais, le log de postgre montre</p>
<pre tabindex="0"><code class="language-fundamental" data-lang="fundamental">postgresql 13:15:22.82
postgresql 13:15:22.82 Welcome to the Bitnami postgresql container
postgresql 13:15:22.82 Subscribe to project updates by watching https://github.com/bitnami/bitnami-docker-postgresql
postgresql 13:15:22.82 Submit issues and feature requests at https://github.com/bitnami/bitnami-docker-postgresql/issues
postgresql 13:15:22.83
postgresql 13:15:22.84 INFO  ==&gt; ** Starting PostgreSQL setup **
postgresql 13:15:22.88 INFO  ==&gt; Validating settings in POSTGRESQL_* env vars..
postgresql 13:15:22.89 INFO  ==&gt; Loading custom pre-init scripts...
postgresql 13:15:22.89 INFO  ==&gt; Initializing PostgreSQL database...
postgresql 13:15:22.92 INFO  ==&gt; pg_hba.conf file not detected. Generating it...
postgresql 13:15:22.92 INFO  ==&gt; Generating local authentication configuration
postgresql 13:15:24.53 INFO  ==&gt; Starting PostgreSQL in background...
postgresql 13:15:24.74 INFO  ==&gt; Changing password of postgres
postgresql 13:15:24.77 INFO  ==&gt; Creating user keycloak
postgresql 13:15:24.79 INFO  ==&gt; Granting access to &#34;keycloak&#34; to the database &#34;keycloak&#34;
postgresql 13:15:24.82 INFO  ==&gt; Setting ownership for the &#39;public&#39; schema database &#34;keycloak&#34; to &#34;keycloak&#34;
postgresql 13:15:24.85 INFO  ==&gt; Configuring replication parameters
postgresql 13:15:24.88 INFO  ==&gt; Configuring synchronous_replication
postgresql 13:15:24.89 INFO  ==&gt; Configuring fsync
postgresql 13:15:24.93 INFO  ==&gt; Loading custom scripts...
postgresql 13:15:24.94 INFO  ==&gt; Enabling remote connections
postgresql 13:15:24.95 INFO  ==&gt; Stopping PostgreSQL...
waiting for server to shut down.... done
server stopped
postgresql 13:15:25.06 INFO  ==&gt; ** PostgreSQL setup finished! **

postgresql 13:15:25.09 INFO  ==&gt; ** Starting PostgreSQL **
2022-05-09 13:15:25.116 GMT [1] LOG:  pgaudit extension initialized
</code></pre><p>Sur un autre cluster, le log de PostgreSQL donne</p>
<pre tabindex="0"><code class="language-fundamental" data-lang="fundamental">postgresql 12:23:01.42
postgresql 12:23:01.42 Welcome to the Bitnami postgresql container
postgresql 12:23:01.42 Subscribe to project updates by watching https://github.com/bitnami/bitnami-docker-postgresql
postgresql 12:23:01.42 Submit issues and feature requests at https://github.com/bitnami/bitnami-docker-postgresql/issues
postgresql 12:23:01.43
postgresql 12:23:01.45 INFO  ==&gt; ** Starting PostgreSQL setup **
postgresql 12:23:01.48 INFO  ==&gt; Validating settings in POSTGRESQL_* env vars..
postgresql 12:23:01.49 INFO  ==&gt; Loading custom pre-init scripts...
postgresql 12:23:01.50 INFO  ==&gt; Initializing PostgreSQL database...
postgresql 12:23:01.53 INFO  ==&gt; pg_hba.conf file not detected. Generating it...
postgresql 12:23:01.53 INFO  ==&gt; Generating local authentication configuration
postgresql 12:23:01.54 INFO  ==&gt; Deploying PostgreSQL with persisted data...
postgresql 12:23:01.56 INFO  ==&gt; Configuring replication parameters
postgresql 12:23:01.59 INFO  ==&gt; Configuring fsync
postgresql 12:23:01.60 INFO  ==&gt; Configuring synchronous_replication
postgresql 12:23:01.64 INFO  ==&gt; Loading custom scripts...
postgresql 12:23:01.64 INFO  ==&gt; Enabling remote connections
postgresql 12:23:01.66 INFO  ==&gt; ** PostgreSQL setup finished! **

postgresql 12:23:01.69 INFO  ==&gt; ** Starting PostgreSQL **
2022-05-09 12:23:01.729 GMT [1] LOG:  pgaudit extension initialized
2022-05-09 12:23:01.735 GMT [1] LOG:  starting PostgreSQL 14.2 on x86_64-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit
2022-05-09 12:23:01.737 GMT [1] LOG:  listening on IPv4 address &#34;0.0.0.0&#34;, port 5432
2022-05-09 12:23:01.737 GMT [1] LOG:  listening on IPv6 address &#34;::&#34;, port 5432
2022-05-09 12:23:01.743 GMT [1] LOG:  listening on Unix socket &#34;/tmp/.s.PGSQL.5432&#34;
2022-05-09 12:23:01.751 GMT [92] LOG:  database system was shut down at 2022-05-05 12:43:18 GMT
2022-05-09 12:23:01.764 GMT [1] LOG:  database system is ready to accept connections
2022-05-09 12:23:18.228 GMT [107] FATAL:  password authentication failed for user &#34;keycloak&#34;
2022-05-09 12:23:18.228 GMT [107] DETAIL:  Connection matched pg_hba.conf line 1: &#34;host     all             all             0.0.0.0/0               md5&#34;
2022-05-09 12:23:18.388 GMT [109] FATAL:  password authentication failed for user &#34;keycloak&#34;
2022-05-09 12:23:18.388 GMT [109] DETAIL:  Connection matched pg_hba.conf line 1: &#34;host     all             all             0.0.0.0/0               md5&#34;
2022-05-09 12:23:18.863 GMT [111] FATAL:  password authentication failed for user &#34;keycloak&#34;
2022-05-09 12:23:18.863 GMT [111] DETAIL:  Connection matched pg_hba.conf line 1: &#34;host     all             all             0.0.0.0/0               md5&#34;
2022-05-09 12:23:19.156 GMT [112] FATAL:  password authentication failed for user &#34;keycloak&#34;
</code></pre><p>Il semble qu&rsquo;il ne se configure pas.</p>
<p>La différence réside sur</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>postgresql 13:15:24.53 INFO  ==&gt; Starting PostgreSQL in background...
</span></span><span style="display:flex;"><span>postgresql 13:15:24.74 INFO  ==&gt; Changing password of postgres
</span></span><span style="display:flex;"><span>postgresql 13:15:24.77 INFO  ==&gt; Creating user keycloak
</span></span><span style="display:flex;"><span>postgresql 13:15:24.79 INFO  ==&gt; Granting access to &#34;keycloak&#34; to the database &#34;keycloak&#34;
</span></span><span style="display:flex;"><span>postgresql 13:15:24.82 INFO  ==&gt; Setting ownership for the &#39;public&#39; schema database &#34;keycloak&#34; to &#34;keycloak&#34;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>postgresql 13:15:24.95 INFO  ==&gt; Stopping PostgreSQL...
</span></span><span style="display:flex;"><span>waiting for server to shut down.... done
</span></span><span style="display:flex;"><span>server stopped
</span></span></code></pre></div><p>contre</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>postgresql 12:23:01.54 INFO  ==&gt; Deploying PostgreSQL with persisted data...
</span></span></code></pre></div><p>On remarque que bitnami utilise un volume pour stocker les données PostgreSQL dans <em>bitnami/postgresql alors que les données de configuration sont dans /opt/bitnami</em>. Aussi,</p>
<p>Je pense que le point d&rsquo;intérêt est dans <a href="https://github.com/bitnami/bitnami-docker-postgresql/blob/master/14/debian-10/rootfs/opt/bitnami/scripts/libpostgresql.sh#L607">cette zone</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> ! is_dir_empty <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_DATA_DIR</span><span style="color:#d14">&#34;</span>; <span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    info <span style="color:#d14">&#34;Deploying PostgreSQL with persisted data...&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0086b3">export</span> <span style="color:#008080">POSTGRESQL_FIRST_BOOT</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;no&#34;</span>
</span></span><span style="display:flex;"><span>    is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_pghba_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_restrict_pghba
</span></span><span style="display:flex;"><span>    is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_conf_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_replication_parameters
</span></span><span style="display:flex;"><span>    is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_conf_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_fsync
</span></span><span style="display:flex;"><span>    is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_conf_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_ENABLE_TLS</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_tls
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">[[</span> <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_REPLICATION_MODE</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;master&#34;</span> <span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">[[</span> -n <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_REPLICATION_USER</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_pghba_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_add_replication_to_pghba
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">[[</span> <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_REPLICATION_MODE</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;master&#34;</span> <span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_pghba_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_synchronous_replication
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">[[</span> <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_REPLICATION_MODE</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;slave&#34;</span> <span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_recovery
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[[</span> <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_REPLICATION_MODE</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;master&#34;</span> <span style="color:#000;font-weight:bold">]]</span>; <span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>        postgresql_master_init_db
</span></span><span style="display:flex;"><span>        postgresql_start_bg <span style="color:#d14">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[[</span> -n <span style="color:#d14">&#34;</span><span style="color:#d14">${</span><span style="color:#008080">POSTGRESQL_DATABASE</span><span style="color:#d14">}</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">[[</span> <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_DATABASE</span><span style="color:#d14">&#34;</span> !<span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;postgres&#34;</span> <span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_create_custom_database
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[[</span> <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_USERNAME</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;postgres&#34;</span> <span style="color:#000;font-weight:bold">]]</span>; <span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>            postgresql_alter_postgres_user <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_PASSWORD</span><span style="color:#d14">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">[[</span> -n <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_POSTGRES_PASSWORD</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">]]</span>; <span style="color:#000;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>                postgresql_alter_postgres_user <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_POSTGRES_PASSWORD</span><span style="color:#d14">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>            postgresql_create_admin_user
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>        is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_pghba_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_restrict_pghba
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[[</span> -n <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_REPLICATION_USER</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_create_replication_user
</span></span><span style="display:flex;"><span>        is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_conf_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_replication_parameters
</span></span><span style="display:flex;"><span>        is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_pghba_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_synchronous_replication
</span></span><span style="display:flex;"><span>        is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_conf_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_fsync
</span></span><span style="display:flex;"><span>        is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_conf_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_ENABLE_TLS</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_tls
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[[</span> -n <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_REPLICATION_USER</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_pghba_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_add_replication_to_pghba
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        postgresql_slave_init_db
</span></span><span style="display:flex;"><span>        is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_pghba_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_restrict_pghba
</span></span><span style="display:flex;"><span>        is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_conf_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_replication_parameters
</span></span><span style="display:flex;"><span>        is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_conf_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_fsync
</span></span><span style="display:flex;"><span>        is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$create_conf_file</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> is_boolean_yes <span style="color:#d14">&#34;</span><span style="color:#008080">$POSTGRESQL_ENABLE_TLS</span><span style="color:#d14">&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> postgresql_configure_tls
</span></span><span style="display:flex;"><span>        postgresql_configure_recovery
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">fi</span>
</span></span></code></pre></div><p>Si les fichiers sont déjà là, on ne va pas appliquer les configurations issues
des variables d&rsquo;environnement $POSTGRESQL_PASSWORD et $POSTGRESQL_USERNAME.</p>
<p>Effectivement, sur le cluster à soucis</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  psql -h localhost -p <span style="color:#099">5432</span> -U keycloak
</span></span><span style="display:flex;"><span>Password <span style="color:#000;font-weight:bold">for</span> user keycloak:
</span></span><span style="display:flex;"><span>psql: error: connection to server at <span style="color:#d14">&#34;localhost&#34;</span> <span style="color:#000;font-weight:bold">(</span>127.0.0.1<span style="color:#000;font-weight:bold">)</span>, port <span style="color:#099">5432</span> failed: FATAL:  password authentication failed <span style="color:#000;font-weight:bold">for</span> user <span style="color:#d14">&#34;keycloak&#34;</span>
</span></span></code></pre></div><p>Sur le cluster OK</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>psql -h localhost -p <span style="color:#099">5432</span> -U keycloak
</span></span><span style="display:flex;"><span>Password <span style="color:#000;font-weight:bold">for</span> user keycloak:
</span></span><span style="display:flex;"><span>psql <span style="color:#000;font-weight:bold">(</span>14.2<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Type <span style="color:#d14">&#34;help&#34;</span> <span style="color:#000;font-weight:bold">for</span> help.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#008080">keycloak</span><span style="color:#000;font-weight:bold">=</span>&gt;
</span></span></code></pre></div><p>Il semble en fait que le mot de passe de keycloak ne soit pas le bon.</p>
<p>Résolution du problème</p>
<ul>
<li>Nous posons le mot de passe de l&rsquo;utilisateur dans un secret k8s.</li>
<li>Or le cluster s&rsquo;est mis à ne plus fonctionner après un helm uninstall &amp;&amp; helm install</li>
<li><a href="/braindump/posts/helm/">helm</a> uninstall supprime le secret mais <a href="/braindump/posts/helm_ne_supprime_pas_les_pvc_des_statefulset/">pas le pvc</a></li>
<li>le mot de passe est généré dans le secret de <a href="#c18b5276-c8f0-4bce-82d7-478fb30efd9f">façon aléatoire</a></li>
<li>quand on réinstalle avec helm, la base de donnée continue à utiliser l&rsquo;ancien
mot de passe, alors qu&rsquo;un nouveau secret, avec un nouveau mot de passe est
créé</li>
</ul>
<h3 id="c18b5276-c8f0-4bce-82d7-478fb30efd9f">comment bitnami génère le mot de passe</h3>
<p>comment <a href="/braindump/posts/bitnami/">bitnami</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000080">data</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- if .Values.auth.enablePostgresUser }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">postgres-password</span>:<span style="color:#bbb"> </span>{{<span style="color:#bbb"> </span>include &#34;common.secrets.passwords.manage&#34; (dict &#34;secret&#34; (include &#34;common.names.fullname&#34; .) &#34;key&#34; &#34;postgres-password&#34; &#34;providedValues&#34; (list &#34;global.postgresql.auth.postgresPassword&#34; &#34;auth.postgresPassword&#34;) &#34;context&#34; $) }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- end }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- if not (empty (include &#34;postgresql.username&#34; .)) }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">password</span>:<span style="color:#bbb"> </span>{{<span style="color:#bbb"> </span>include &#34;common.secrets.passwords.manage &#34; (dict &#34;secret&#34; (include &#34;common.names.fullname&#34; .) &#34;key&#34; &#34;password&#34; &#34;providedValues&#34; (list &#34;global.postgresql.auth.password&#34; &#34;auth.password&#34;) &#34;context&#34; $) }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- end }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- if eq .Values.architecture &#34;replication&#34; }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">replication-password</span>:<span style="color:#bbb"> </span>{{<span style="color:#bbb"> </span>include &#34;common.secrets.passwords.manage&#34; (dict &#34;secret&#34; (include &#34;common.names.fullname&#34; .) &#34;key&#34; &#34;replication-password&#34; &#34;providedValues&#34; (list &#34;auth.replicationPassword&#34;) &#34;context&#34; $) }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- end }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic"># We don&#39;t auto-generate LDAP password when it&#39;s not provided as we do for other passwords</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- if and .Values.ldap.enabled .Values.ldap.bind_password }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000080">ldap-password</span>:<span style="color:#bbb"> </span>{{<span style="color:#bbb"> </span>.Values.ldap.bind_password | b64enc | quote }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- end }}<span style="color:#bbb">
</span></span></span></code></pre></div><p>puis, dans la dépendance common de postgre de bitnami</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{{- define &#34;common.secrets.passwords.manage&#34; -}}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- $password := &#34;&#34; }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- $subchart := &#34;&#34; }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- $chartName := default &#34;&#34; .chartName }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- $passwordLength := default 10 .length }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- $providedPasswordKey := include &#34;common.utils.getKeyFromList&#34; (dict &#34;keys&#34; .providedValues &#34;context&#34; $.context) }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- $providedPasswordValue := include &#34;common.utils.getValueFromKey&#34; (dict &#34;key&#34; $providedPasswordKey &#34;context&#34; $.context) }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- $secretData := (lookup &#34;v1&#34; &#34;Secret&#34; $.context.Release.Namespace .secret).data }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- if $secretData }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- if hasKey $secretData .key }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>{{- $password = index $secretData .key }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- else }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>{{- printf &#34;\nPASSWORDS ERROR: The secret \&#34;%s\&#34; does not contain the key \&#34;%s\&#34;\n&#34; .secret .key | fail -}}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- end -}}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- else if $providedPasswordValue }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- $password = $providedPasswordValue | toString | b64enc | quote }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- else }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- if .context.Values.enabled }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>{{- $subchart = $chartName }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- end -}}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- $requiredPassword := dict &#34;valueKey&#34; $providedPasswordKey &#34;secret&#34; .secret &#34;field&#34; .key &#34;subchart&#34; $subchart &#34;context&#34; $.context -}}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- $requiredPasswordError := include &#34;common.validations.values.single.empty&#34; $requiredPassword -}}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- $passwordValidationErrors := list $requiredPasswordError -}}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- include &#34;common.errors.upgrade.passwords.empty&#34; (dict &#34;validationErrors&#34; $passwordValidationErrors &#34;context&#34; $.context) -}}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- if .strong }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>{{- $subStr := list (lower (randAlpha 1)) (randNumeric 1) (upper (randAlpha 1)) | join &#34;_&#34; }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>{{- $password = randAscii $passwordLength }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>{{- $password = regexReplaceAllLiteral &#34;\\W&#34; $password &#34;@&#34; | substr 5 $passwordLength }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>{{- $password = printf &#34;%s%s&#34; $subStr $password | toString | shuffle | b64enc | quote }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- else }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>{{- $password = randAlphaNum $passwordLength | b64enc | quote }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{{- end }}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- end -}}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- printf &#34;%s&#34; $password -}}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{{- end -}}<span style="color:#bbb">
</span></span></span></code></pre></div><h2 id="86d86863-eefc-4873-a27e-3142e2f3ee55">pg_dump</h2>
<h2 id="33b0ac7e-6473-4cb5-a2c5-e35eb6d1a53d">deduplicate rows</h2>
<p>Provided there is no already existing id columns.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">alter</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">table</span><span style="color:#bbb"> </span>mytable<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">add</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">column</span><span style="color:#bbb"> </span>id<span style="color:#bbb"> </span><span style="color:#0086b3">serial</span><span style="color:#bbb">
</span></span></span></code></pre></div><p>Then, partition other some commun attribute and find the row number.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">delete</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">from</span><span style="color:#bbb"> </span>mytable<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">where</span><span style="color:#bbb"> </span>id<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">in</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">select</span><span style="color:#bbb"> </span>id<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">from</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">               </span><span style="color:#000;font-weight:bold">select</span><span style="color:#bbb"> </span>id,<span style="color:#bbb"> </span>cid,<span style="color:#bbb"> </span>row_number()<span style="color:#bbb"> </span>over(partition<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">by</span><span style="color:#bbb"> </span>cid)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">from</span><span style="color:#bbb"> </span>mytable<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- group by the cid and show the row number
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">        </span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">as</span><span style="color:#bbb"> </span>withrows<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">where</span><span style="color:#bbb"> </span>row_number<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- find only the ones with more than 1 match
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>)<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">-- remove them
</span></span></span></code></pre></div><p>Then, remove the temporary id column.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">alter</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">table</span><span style="color:#bbb"> </span>mytable<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">drop</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">column</span><span style="color:#bbb"> </span>id<span style="color:#bbb">
</span></span></span></code></pre></div><!--more-->
<h2 id="notes-pointant-ici">Notes pointant ici</h2>
<ul>
<li><a href="/braindump/posts/how_do_i_limit_the_resources_that_pg_dump_uses/">how do I limit the resources that pg_dump uses?</a></li>
<li><a href="https://konubinix.eu/blog/posts/how_do_i_store_my_files/?title=how_do_i_store_my_files#">how do I store my files?</a> (blog)</li>
<li><a href="/braindump/posts/how_i_organize_my_static_files_with_ipfs_and_org_roam/">how I organize my static files with IPFS and org-roam</a></li>
<li><a href="/braindump/posts/how_to_organise_the_inter_subchart_networkpolicies/">how to organise the inter subchart networkpolicies?</a></li>
<li><a href="/braindump/posts/postgresql_in_emacs/">postgresql in emacs</a></li>
<li><a href="/braindump/posts/postgresql_stopped_working_on_my_raspberrypi/">postgresql stopped working on my raspberrypi</a></li>
</ul>
<h2 id="permalink"><a href="https://konubinix.eu/braindump/88ed3b09-d433-47c8-b0c5-63466775644f?title=postgresql">Permalink</a></h2>
      </div>
	  <aside class="date"><time>Last updated: 04 Mar 2024</time></aside>
	  <aside class="date"><time>Published&nbsp;&nbsp;&nbsp;: 07 Apr 2021</time></aside>
    </div>
  </div>
</div>

<script src="/braindump/js/URI.js" type="text/javascript"></script>

<script src="/braindump/js/page.js" type="text/javascript"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>
