<!DOCTYPE html>
<html><title>  docker buildx cross compiling python to armhf: &#34;Fatal Python error: pyinit_main: can&#39;t initialize time&#34;
  </title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="bLmaFyyXugiCqSup-eIIIx0B4CngtdF_svyMMKQbS5E" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10, minimum-scale=0.5, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes" />
<script src="https://hypothes.is/embed.js" async></script>


<link rel="stylesheet" href="/braindump/css/main.min.56b43bcbc759a196f9dd525bee62bdec45a29ba95902bbab74a4f7ad2ea3e8cb.css"/>

<link rel="stylesheet" href="/braindump/css/links.min.4bf1990b213fb76d2a66153dc6ef9a57d49f536c6baf6e7f19a7948470a38141.css"/>

<link rel="stylesheet" href="/braindump/css/konubinix.min.cf2d0f36945178c647979ee68f1830892e06aa3d481d8913728b5c7462b97f6e.css"/>

<link rel="stylesheet" href="/ipfs/QmQFVQS89fv1XUNFcjwCKDePzckuT9kpuAVNYUwNdEfYcv/css/all.css"/>
<link rel="shortcut icon" href="/ipfs/QmVFwYV7YRZLKU3ybN1hW4jqfyZGPLKJwd8toN2wHz5UAD?a.png" type="image/x-icon" />

<body><header>
  <div>
	<a href="/braindump//"><h5 class="site-title">Konubinix&#39; opinionated web of thoughts</h5></a>
  </div>
  <span>
	<a href="/blog/"><i class="icon fas fa-blog"></i></a>
	<a href="/braindump/posts/"><i class="icon fas fa-brain"></i></a>
    <a href="mailto:konubinixweb@gmail.com"><i class="icon fas fa-envelope-square"></i></a>
    <a href="https://github.com/konubinix"><i class="icon fab fa-github-square"></i></a>
    <a href="https://linkedin.com/in/samuel-loury-61259040"><i class="icon fab fa-linkedin"></i></a>
	<a href="/braindump/graph.html"><i class="icon fas fa-project-diagram"></i></a>
	<a href="/braindump/index.xml"><i class="icon fas fa-rss-square"></i></a>
	<a href="/braindump/tags/"><i class="icon fa fa-tag"></i></a>
	<a href="/braindump/braindump_search"><i class="icon fa fa-search"></i></a>
  </span>
</header>

<div class="grid-container">
  <div class="grid">
    <div class="page" data-level="1">
      <div class="content">
		<p class="lead">
        <h1>  Docker Buildx Cross Compiling Python to Armhf: &#34;Fatal Python Error: Pyinit_main: Can&#39;t Initialize Time&#34;
  </h1>
		<span class="badge badge-pill badge-warning"><a href="/braindump/tags/fleeting/">Fleeting</a></span></p>
        <h2 id="the-symptoms">The symptoms</h2>
<p>When running</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>uname -a
</span></span><span style="display:flex;"><span>docker version
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Linux konixwork 5.8.0-2-amd64 #1 SMP Debian 5.8.10-1 (2020-09-19) x86_64 GNU/Linux
</span></span><span style="display:flex;"><span>Client: Docker Engine - Community
</span></span><span style="display:flex;"><span> Version:           19.03.13
</span></span><span style="display:flex;"><span> API version:       1.40
</span></span><span style="display:flex;"><span> Go version:        go1.13.15
</span></span><span style="display:flex;"><span> Git commit:        4484c46d9d
</span></span><span style="display:flex;"><span> Built:             Wed Sep 16 17:02:55 2020
</span></span><span style="display:flex;"><span> OS/Arch:           linux/amd64
</span></span><span style="display:flex;"><span> Experimental:      true
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Server: Docker Engine - Community
</span></span><span style="display:flex;"><span> Engine:
</span></span><span style="display:flex;"><span>  Version:          19.03.13
</span></span><span style="display:flex;"><span>  API version:      1.40 (minimum version 1.12)
</span></span><span style="display:flex;"><span>  Go version:       go1.13.15
</span></span><span style="display:flex;"><span>  Git commit:       4484c46d9d
</span></span><span style="display:flex;"><span>  Built:            Wed Sep 16 17:01:25 2020
</span></span><span style="display:flex;"><span>  OS/Arch:          linux/amd64
</span></span><span style="display:flex;"><span>  Experimental:     true
</span></span><span style="display:flex;"><span> containerd:
</span></span><span style="display:flex;"><span>  Version:          1.3.7
</span></span><span style="display:flex;"><span>  GitCommit:        8fba4e9a7d01810a393d5d25a3621dc101981175
</span></span><span style="display:flex;"><span> runc:
</span></span><span style="display:flex;"><span>  Version:          1.0.0-rc10
</span></span><span style="display:flex;"><span>  GitCommit:        dc9208a3303feef5b3839f4323d9beb36df0a9dd
</span></span><span style="display:flex;"><span> docker-init:
</span></span><span style="display:flex;"><span>  Version:          0.18.0
</span></span><span style="display:flex;"><span>  GitCommit:        fec3683
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh blueberry uname -a <span style="color:#000;font-weight:bold">&amp;&amp;</span> ssh blueberry docker version
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Linux blueberry 4.19.75-v7+ #1270 SMP Tue Sep 24 18:45:11 BST 2019 armv7l GNU/Linux
</span></span><span style="display:flex;"><span>Client: Docker Engine - Community
</span></span><span style="display:flex;"><span> Version:           19.03.5
</span></span><span style="display:flex;"><span> API version:       1.40
</span></span><span style="display:flex;"><span> Go version:        go1.12.12
</span></span><span style="display:flex;"><span> Git commit:        633a0ea
</span></span><span style="display:flex;"><span> Built:             Wed Nov 13 07:37:22 2019
</span></span><span style="display:flex;"><span> OS/Arch:           linux/arm
</span></span><span style="display:flex;"><span> Experimental:      false
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Server: Docker Engine - Community
</span></span><span style="display:flex;"><span> Engine:
</span></span><span style="display:flex;"><span>  Version:          19.03.5
</span></span><span style="display:flex;"><span>  API version:      1.40 (minimum version 1.12)
</span></span><span style="display:flex;"><span>  Go version:       go1.12.12
</span></span><span style="display:flex;"><span>  Git commit:       633a0ea
</span></span><span style="display:flex;"><span>  Built:            Wed Nov 13 07:31:17 2019
</span></span><span style="display:flex;"><span>  OS/Arch:          linux/arm
</span></span><span style="display:flex;"><span>  Experimental:     false
</span></span><span style="display:flex;"><span> containerd:
</span></span><span style="display:flex;"><span>  Version:          1.2.10
</span></span><span style="display:flex;"><span>  GitCommit:        b34a5c8af56e510852c35414db4c1f4fa6172339
</span></span><span style="display:flex;"><span> runc:
</span></span><span style="display:flex;"><span>  Version:          1.0.0-rc8+dev
</span></span><span style="display:flex;"><span>  GitCommit:        3e425f80a8c931f88e6d94a8c831b9d5aa481657
</span></span><span style="display:flex;"><span> docker-init:
</span></span><span style="display:flex;"><span>  Version:          0.18.0
</span></span><span style="display:flex;"><span>  GitCommit:        fec3683
</span></span></code></pre></div><p>The docker file is</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">FROM</span><span style="color:#d14"> alpine</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000;font-weight:bold">RUN</span> apk add --update python3<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#000;font-weight:bold">CMD</span> [<span style="color:#d14">&#34;python3&#34;</span>, <span style="color:#d14">&#34;-c&#34;</span>, <span style="color:#d14">&#34;print(&#39;ok&#39;)&#34;</span>]<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span></code></pre></div><p>Building and running this on my desktop</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker buildx build ~/tmp/docker -t localhost:9692/testalpine --push 2&gt;&amp;<span style="color:#099">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>time=&#34;2021-01-22T13:41:48+01:00&#34; level=warning msg=&#34;invalid non-bool value for BUILDX_NO_DEFAULT_LOAD: &#34;
</span></span><span style="display:flex;"><span>#1 [internal] load build definition from Dockerfile
</span></span><span style="display:flex;"><span>#1 DONE 0.0s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#1 [internal] load build definition from Dockerfile
</span></span><span style="display:flex;"><span>#1 transferring dockerfile: 31B done
</span></span><span style="display:flex;"><span>#1 DONE 0.0s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#2 [internal] load .dockerignore
</span></span><span style="display:flex;"><span>#2 transferring context: 2B done
</span></span><span style="display:flex;"><span>#2 DONE 0.0s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#3 [internal] load metadata for docker.io/library/alpine:latest
</span></span><span style="display:flex;"><span>#3 DONE 0.5s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#4 [1/2] FROM docker.io/library/alpine@sha256:d9a7354e3845ea8466bb00b22224d...
</span></span><span style="display:flex;"><span>#4 resolve docker.io/library/alpine@sha256:d9a7354e3845ea8466bb00b22224d9116b183e594527fb5b6c3d30bc01a20378 0.0s done
</span></span><span style="display:flex;"><span>#4 DONE 0.0s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#5 [2/2] RUN apk add --update python3
</span></span><span style="display:flex;"><span>#5 CACHED
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#6 exporting to image
</span></span><span style="display:flex;"><span>#6 exporting layers done
</span></span><span style="display:flex;"><span>#6 exporting manifest sha256:f65439ea3152cecd80544dc064a638f137addb7304e5aaa98e4d9543214121ac 0.0s done
</span></span><span style="display:flex;"><span>#6 exporting config sha256:4260c9e0fe4cad647f64e860bed99d248fc7b637dd7ee07df695575b5224a269 0.0s done
</span></span><span style="display:flex;"><span>#6 pushing layers 0.0s done
</span></span><span style="display:flex;"><span>#6 pushing manifest for localhost:9692/testalpine:latest done
</span></span><span style="display:flex;"><span>#6 DONE 0.1s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run --rm localhost:9692/testalpine
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ok
</span></span></code></pre></div><p>When running it on the raspberry pi 3B+</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh blueberry mkdir -p docker <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>scp ~/tmp/docker/Dockerfile blueberry:docker/ <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>ssh blueberry ls docker
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Dockerfile
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh blueberry docker build -t <span style="color:#0086b3">test</span> ./docker
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Sending build context to Docker daemon  2.048kB
</span></span><span style="display:flex;"><span>Step 1/3 : FROM alpine
</span></span><span style="display:flex;"><span> ---&gt; 7e4bece93b3e
</span></span><span style="display:flex;"><span>Step 2/3 : RUN apk add --update python3
</span></span><span style="display:flex;"><span> ---&gt; Using cache
</span></span><span style="display:flex;"><span> ---&gt; 9d8dcef4c292
</span></span><span style="display:flex;"><span>Step 3/3 : CMD [&#34;python3&#34;, &#34;-c&#34;, &#34;print(&#39;ok&#39;)&#34;]
</span></span><span style="display:flex;"><span> ---&gt; Running in 9c79e94c140b
</span></span><span style="display:flex;"><span>Removing intermediate container 9c79e94c140b
</span></span><span style="display:flex;"><span> ---&gt; 39c5199bceff
</span></span><span style="display:flex;"><span>Successfully built 39c5199bceff
</span></span><span style="display:flex;"><span>Successfully tagged test:latest
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh blueberry docker run --rm <span style="color:#0086b3">test</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ok
</span></span></code></pre></div><p>Then, now let&rsquo;s try to cross compile the image.</p>
<p>First, setup the qemu layer.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run --rm --privileged fkrull/qemu-user-static <span style="color:#0086b3">enable</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>    docker buildx create <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>                   --name builder <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>                   --driver-opt <span style="color:#008080">network</span><span style="color:#000;font-weight:bold">=</span>host <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>    docker buildx use builder <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>    docker buildx inspect --bootstrap
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>enabling qemu-aarch64 ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-alpha ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-arm ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-armeb ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-cris ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-m68k ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-microblaze ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-mips ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-mips64 ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-mips64el ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-mipsel ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-ppc ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-ppc64 ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-ppc64abi32 ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-ppc64le ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-s390x ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-sh4 ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-sh4eb ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-sparc ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-sparc32plus ... skipping
</span></span><span style="display:flex;"><span>enabling qemu-sparc64 ... skipping
</span></span><span style="display:flex;"><span>builder
</span></span><span style="display:flex;"><span>Name:   builder
</span></span><span style="display:flex;"><span>Driver: docker-container
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Nodes:
</span></span><span style="display:flex;"><span>Name:      builder0
</span></span><span style="display:flex;"><span>Endpoint:  unix:///var/run/docker.sock
</span></span><span style="display:flex;"><span>Status:    running
</span></span><span style="display:flex;"><span>Platforms: linux/amd64, linux/arm64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6
</span></span></code></pre></div><p>Ok, let&rsquo;s cross compile it for armv7</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker buildx build ~/tmp/docker --platform linux/arm/v7 -t localhost:9692/testalpine --push 2&gt;&amp;<span style="color:#099">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>time=&#34;2021-01-22T13:47:42+01:00&#34; level=warning msg=&#34;invalid non-bool value for BUILDX_NO_DEFAULT_LOAD: &#34;
</span></span><span style="display:flex;"><span>#1 [internal] load build definition from Dockerfile
</span></span><span style="display:flex;"><span>#1 transferring dockerfile: 115B done
</span></span><span style="display:flex;"><span>#1 DONE 0.2s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#2 [internal] load .dockerignore
</span></span><span style="display:flex;"><span>#2 transferring context: 2B done
</span></span><span style="display:flex;"><span>#2 DONE 0.2s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#3 [internal] load metadata for docker.io/library/alpine:latest
</span></span><span style="display:flex;"><span>#3 DONE 2.6s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#4 [1/2] FROM docker.io/library/alpine@sha256:d9a7354e3845ea8466bb00b22224d...
</span></span><span style="display:flex;"><span>#4 resolve docker.io/library/alpine@sha256:d9a7354e3845ea8466bb00b22224d9116b183e594527fb5b6c3d30bc01a20378 0.0s done
</span></span><span style="display:flex;"><span>#4 DONE 0.1s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#4 [1/2] FROM docker.io/library/alpine@sha256:d9a7354e3845ea8466bb00b22224d...
</span></span><span style="display:flex;"><span>#4 sha256:0f34ce5da94097b8c334f6b2065a010aced9855c3532e4462e9bd1b0a4c4b3f6 0B / 2.42MB 0.2s
</span></span><span style="display:flex;"><span>#4 sha256:0f34ce5da94097b8c334f6b2065a010aced9855c3532e4462e9bd1b0a4c4b3f6 1.05MB / 2.42MB 0.3s
</span></span><span style="display:flex;"><span>#4 sha256:0f34ce5da94097b8c334f6b2065a010aced9855c3532e4462e9bd1b0a4c4b3f6 2.42MB / 2.42MB 0.4s done
</span></span><span style="display:flex;"><span>#4 extracting sha256:0f34ce5da94097b8c334f6b2065a010aced9855c3532e4462e9bd1b0a4c4b3f6 0.1s done
</span></span><span style="display:flex;"><span>#4 DONE 0.5s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#5 [2/2] RUN apk add --update python3
</span></span><span style="display:flex;"><span>#5 0.114 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.114 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.114 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.114 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.114 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.119 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.119 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.120 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.120 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.134 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.134 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.135 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.140 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.141 qemu: Unsupported syscall: 403
</span></span><span style="display:flex;"><span>#5 0.142 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 0.142 fetch https://dl-cdn.alpinelinux.org/alpine/v3.13/main/armv7/APKINDEX.tar.gz
</span></span><span style="display:flex;"><span>#5 0.144 qemu: Unsupported syscall: 403
</span></span><span style="display:flex;"><span>[repeated 42 times]
</span></span><span style="display:flex;"><span>#5 1.019 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.019 fetch https://dl-cdn.alpinelinux.org/alpine/v3.13/community/armv7/APKINDEX.tar.gz
</span></span><span style="display:flex;"><span>#5 1.859 (1/11) Installing libbz2 (1.0.8-r1)
</span></span><span style="display:flex;"><span>#5 1.884 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.884 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.887 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.887 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.887 (2/11) Installing libgcc (10.2.1_pre1-r3)
</span></span><span style="display:flex;"><span>#5 1.912 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.912 (3/11) Installing expat (2.2.10-r1)
</span></span><span style="display:flex;"><span>#5 1.932 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.936 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.936 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.936 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.936 (4/11) Installing libffi (3.3-r2)
</span></span><span style="display:flex;"><span>#5 1.980 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.980 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 1.980 (5/11) Installing gdbm (1.19-r0)
</span></span><span style="display:flex;"><span>#5 2.006 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.006 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.006 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.006 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.006 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.006 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.006 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.007 (6/11) Installing xz-libs (5.2.5-r0)
</span></span><span style="display:flex;"><span>#5 2.035 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.036 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.036 (7/11) Installing ncurses-terminfo-base (6.2_p20210109-r0)
</span></span><span style="display:flex;"><span>#5 2.055 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>[repeated 54 times]
</span></span><span style="display:flex;"><span>#5 2.061 (8/11) Installing ncurses-libs (6.2_p20210109-r0)
</span></span><span style="display:flex;"><span>#5 2.099 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.099 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.099 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.099 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.099 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.099 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.099 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.099 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.099 (9/11) Installing readline (8.1.0-r0)
</span></span><span style="display:flex;"><span>#5 2.131 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.131 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.131 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.131 (10/11) Installing sqlite-libs (3.34.1-r0)
</span></span><span style="display:flex;"><span>#5 2.199 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.199 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>#5 2.199 (11/11) Installing python3 (3.8.7-r0)
</span></span><span style="display:flex;"><span>#5 2.228 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>[repeated 2692 times]
</span></span><span style="display:flex;"><span>#5 3.877 Executing busybox-1.32.1-r0.trigger
</span></span><span style="display:flex;"><span>#5 3.878 qemu: Unsupported syscall: 397
</span></span><span style="display:flex;"><span>[repeated 120 times]
</span></span><span style="display:flex;"><span>#5 3.908 qemu: Unsupported syscall: 403
</span></span><span style="display:flex;"><span>#5 3.909 OK: 48 MiB in 25 packages
</span></span><span style="display:flex;"><span>#5 DONE 5.0s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#6 exporting to image
</span></span><span style="display:flex;"><span>#6 exporting layers
</span></span><span style="display:flex;"><span>#6 exporting layers 2.0s done
</span></span><span style="display:flex;"><span>#6 exporting manifest sha256:5ee08abf8fbd46cf84bb5936939c0218c2830ac996dbc3cb7786ae0be6bc4548 0.0s done
</span></span><span style="display:flex;"><span>#6 exporting config sha256:f4e4e9f213a521e319686083dd1b46883ca87797b945dfc805d3a9cb3d3d2dbd 0.0s done
</span></span><span style="display:flex;"><span>#6 pushing layers
</span></span><span style="display:flex;"><span>#6 pushing layers 4.3s done
</span></span><span style="display:flex;"><span>#6 pushing manifest for localhost:9692/testalpine:latest
</span></span><span style="display:flex;"><span>#6 pushing manifest for localhost:9692/testalpine:latest 0.3s done
</span></span><span style="display:flex;"><span>#6 DONE 6.7s
</span></span></code></pre></div><p>And then run it on the raspberry pi.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh blueberry docker run --rm localhost:9692/testalpine
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Fatal Python error: pyinit_main: can&#39;t initialize time
</span></span><span style="display:flex;"><span>Python runtime state: core initialized
</span></span><span style="display:flex;"><span>PermissionError: [Errno 1] Operation not permitted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Current thread 0x76f44390 (most recent call first):
</span></span><span style="display:flex;"><span>&lt;no Python frame&gt;
</span></span></code></pre></div><p>The image works well, only running python causes this error.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh blueberry docker run --rm localhost:9692/testalpine ls
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bin
</span></span><span style="display:flex;"><span>dev
</span></span><span style="display:flex;"><span>etc
</span></span><span style="display:flex;"><span>home
</span></span><span style="display:flex;"><span>lib
</span></span><span style="display:flex;"><span>media
</span></span><span style="display:flex;"><span>mnt
</span></span><span style="display:flex;"><span>opt
</span></span><span style="display:flex;"><span>proc
</span></span><span style="display:flex;"><span>root
</span></span><span style="display:flex;"><span>run
</span></span><span style="display:flex;"><span>sbin
</span></span><span style="display:flex;"><span>srv
</span></span><span style="display:flex;"><span>sys
</span></span><span style="display:flex;"><span>tmp
</span></span><span style="display:flex;"><span>usr
</span></span><span style="display:flex;"><span>var
</span></span></code></pre></div><h2 id="analysis">Analysis</h2>
<p>We can see that qemu cannot run the following syscalls</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Unsupported syscall: 397
</span></span><span style="display:flex;"><span>Unsupported syscall: 403
</span></span></code></pre></div><p>If I remind correctly, it already complained in the past but it was still
working.  According to <a href="https://fedora.juszkiewicz.com.pl/syscalls.html">https://fedora.juszkiewicz.com.pl/syscalls.html</a>, 397
is statx and 403 is clock_gettime64 in arm.</p>
<p>Also, <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=951012">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=951012</a> appears to
say that 403 is related to seccomp.</p>
<p>Looking for this particular error on the web, I get few results.</p>
<p><a href="https://github.com/linuxserver/docker-papermerge/issues/4">https://github.com/linuxserver/docker-papermerge/issues/4</a></p>
<blockquote>
<p>You need a updated version of libseccomp2, 2.4.3-1 or higher. It is currently
not available for Raspberry PI OS, but it is for Ubuntu. You can look into
downloading the Deb from Ubuntus repository.</p>
</blockquote>
<p>Interesting, it also talks about <a href="/braindump/posts/seccomp/">seccomp</a>.</p>
<dl>
<dt><a href="https://lists.debian.org/deity/2020/02/msg00025.html">Bug#951012: buster-kernel 5.5-armhf-seccomp: syscall 403</a></dt>
<dd><blockquote>
<p>I looked into this, this is is new time64 syscall, I&rsquo;ll be going ahead
and whitelist all new time64 syscalls in 1.9.10.</p>
<p>403: clock_gettime64
404: clock_settime64
405: clock_adjtime64
406: clock_getres_time64
407: clock_nanosleep_time64
408: timer_gettime64
409: timer_settime64
410: timerfd_gettime64
411: timerfd_settime64
412: utimensat_time64
413: pselect6_time64
414: ppoll_time64</p>
</blockquote>
</dd>
<dt><a href="https://lists.debian.org/deity/2020/02/msg00032.html">Bug#951012: buster-kernel 5.5-armhf-seccomp: syscall 403</a></dt>
<dd><blockquote>
<p>&gt; Of course, feel free to whitelist them in your apt.conf, by setting
&gt;
&gt; APT::Sandbox::Seccomp::Allow { &ldquo;clock_gettime64&rdquo;; &lt;other syscalls&gt; }
&gt;
&gt; as I don&rsquo;t think this will get cherry-picked into stable releases.</p>
</blockquote>
</dd>
</dl>
<p>It sounds like a good hypothesis, seccomp prevents the syscall clock_gettime64
to run and python in alpine now wants to make use of it. It does not answer the
question why it work when built locally though.</p>
<p>May be this has something to do with the fact my host is running linux 5x while
the raspberri is running linux 4x.</p>
<dl>
<dt><a href="https://docs.docker.com/engine/security/seccomp/">Seccomp security profiles for Docker | Docker Documentation</a></dt>
<dd><blockquote>
<p>You can pass unconfined to run a container without the default seccomp profile.</p>
<p>$ docker run &ndash;rm -it &ndash;security-opt seccomp=unconfined debian:jessie \
unshare &ndash;map-root-user &ndash;user sh -c whoami</p>
</blockquote>
Let&rsquo;s try this.
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh blueberry docker run --security-opt <span style="color:#008080">seccomp</span><span style="color:#000;font-weight:bold">=</span>unconfined --rm localhost:9692/testalpine 2&gt;&amp;<span style="color:#099">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ok
</span></span></code></pre></div></dd>
</dl>
<p>Ok, so it looks like docker in the <a href="/braindump/posts/raspberry_pi/">raspberry pi</a> prevented the syscall 403
to run.</p>
<p>Let&rsquo;s try to use the default docker profile to see if it is indeed the <a href="/braindump/posts/syscall_403/">syscall 403</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh blueberry wget https://raw.githubusercontent.com/moby/moby/master/profiles/seccomp/default.json <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>    ssh blueberry docker run --security-opt <span style="color:#008080">seccomp</span><span style="color:#000;font-weight:bold">=</span>default.json --rm localhost:9692/testalpine 2&gt;&amp;<span style="color:#099">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ok
</span></span></code></pre></div><p>And we can see in this profile that clock_gettime64 is indeed allowed.</p>
<p>Now, let&rsquo;s try to remove this syscall and see what happens.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh blueberry sed -i <span style="color:#d14">&#39;/clock_gettime64/d&#39;</span> default.json <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>    ssh blueberry docker run --security-opt <span style="color:#008080">seccomp</span><span style="color:#000;font-weight:bold">=</span>default.json --rm localhost:9692/testalpine
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Fatal Python error: pyinit_main: can&#39;t initialize time
</span></span><span style="display:flex;"><span>Python runtime state: core initialized
</span></span><span style="display:flex;"><span>PermissionError: [Errno 1] Operation not permitted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Current thread 0x76fd5390 (most recent call first):
</span></span><span style="display:flex;"><span>&lt;no Python frame&gt;
</span></span></code></pre></div><p>We get the error, as expected.</p>
<h2 id="conclusion">Conclusion</h2>
<p>My working hypothesis is now.</p>
<p>If I build the docker image in the <a href="/braindump/posts/raspberry_pi/">raspberry pi</a></p>
<ol>
<li>it is using linux 4</li>
<li>then it does not use the syscall clock_gettime64</li>
<li>the image can be run Successfully</li>
</ol>
<p>If I build the image in my laptop</p>
<ol>
<li>it is using linux 5</li>
<li>it uses clock_gettime64</li>
<li>the rasperry pi try to use it</li>
<li>it fails because docker does not allow it</li>
</ol>
<p>It does not tell why the syscall clock_gettime64 that appears to work in
<a href="/braindump/posts/raspberry_pi/">raspberry pi</a> is not used in linux prior to 5.</p>
<p>So I guess I can use a &ndash;security-opt profile for now and wait for the kernels
to be in sync.</p>
<p>Or I can update libseccomp in my <a href="/braindump/posts/raspberry_pi/">raspberry pi</a> as suggested in <a href="/braindump/posts/after_update_docker_starts_only_with_privileged_true/">After Update Docker starts only with privileged: true</a>.</p>
<!--more-->
<h2 id="notes-linking-here">Notes linking here</h2>
<ul>
<li><a href="/braindump/posts/how_to_mitigate_the_buildx_bug_in_cross_compiling_on_arm_in_nomad/">how to mitigate the buildx bug in cross compiling on arm in nomad?</a></li>
<li><a href="/braindump/posts/is_syscall_403_really_used_in_python_in_raspbian/">is syscall 403 really used in python in raspbian?</a></li>
<li><a href="/braindump/posts/postgresql_stopped_working_on_my_raspberrypi/">postgresql stopped working on my raspberrypi</a></li>
<li><a href="/braindump/posts/when_did_docker_accept_the_syscall_403/">when did docker accept the syscall 403?</a></li>
</ul>
<h2 id="permalink"><a href="https://konubinix.eu/braindump/005ce0e4-4d23-4fca-80ad-67a58410dc54?title=docker_buildx_cross_compiling_python_to_armhf_fatal_python_error_pyinit_main_can_t_initialize_time">Permalink</a></h2>
      </div>
	  <aside class="date"><time>Last updated: 27 Oct 2021</time></aside>
	  <aside class="date"><time>Published&nbsp;&nbsp;&nbsp;: 22 Jan 2021</time></aside>
    </div>
  </div>
</div>

<script src="/braindump/js/URI.js" type="text/javascript"></script>

<script src="/braindump/js/page.js" type="text/javascript"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>
