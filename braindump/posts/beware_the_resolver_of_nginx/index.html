<!DOCTYPE html>
<html><title>beware the resolver of nginx</title>


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="bLmaFyyXugiCqSup-eIIIx0B4CngtdF_svyMMKQbS5E" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10, minimum-scale=0.5, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes" />
<script src="https://hypothes.is/embed.js" async></script>


<link rel="stylesheet" href="/braindump/css/main.min.56b43bcbc759a196f9dd525bee62bdec45a29ba95902bbab74a4f7ad2ea3e8cb.css"/>

<link rel="stylesheet" href="/braindump/css/links.min.4bf1990b213fb76d2a66153dc6ef9a57d49f536c6baf6e7f19a7948470a38141.css"/>

<link rel="stylesheet" href="/braindump/css/konubinix.min.cf2d0f36945178c647979ee68f1830892e06aa3d481d8913728b5c7462b97f6e.css"/>

<link rel="stylesheet" href="/ipfs/QmQFVQS89fv1XUNFcjwCKDePzckuT9kpuAVNYUwNdEfYcv/css/all.css"/>
<link rel="shortcut icon" href="/ipfs/QmVFwYV7YRZLKU3ybN1hW4jqfyZGPLKJwd8toN2wHz5UAD?a.png" type="image/x-icon" />

<body><header>
  <div>
	<a href="/braindump//"><h5 class="site-title">Konubinix&#39; opinionated web of thoughts</h5></a>
  </div>
  <span>
	<a href="/blog/"><i class="icon fas fa-blog"></i></a>
	<a href="/braindump/posts/"><i class="icon fas fa-brain"></i></a>
    <a href="mailto:konubinixweb@gmail.com"><i class="icon fas fa-envelope-square"></i></a>
    <a href="https://github.com/konubinix"><i class="icon fab fa-github-square"></i></a>
    <a href="https://linkedin.com/in/samuel-loury-61259040"><i class="icon fab fa-linkedin"></i></a>
	<a href="/braindump/graph.html"><i class="icon fas fa-project-diagram"></i></a>
	<a href="/braindump/index.xml"><i class="icon fas fa-rss-square"></i></a>
	<a href="/braindump/tags/"><i class="icon fa fa-tag"></i></a>
	<a href="/braindump/braindump_search"><i class="icon fa fa-search"></i></a>
  </span>
</header>

<div class="grid-container">
  <div class="grid">
    <div class="page" data-level="1">
      <div class="content">
		<p class="lead">
        <h1>Beware the Resolver of Nginx</h1>
		<span class="badge badge-pill badge-warning"><a href="/braindump/tags/fleeting/">Fleeting</a></span></p>
        <div class="ox-hugo-toc toc">
<div class="heading">Table of Contents</div>
<ul>
<li><a href="#a22baef3-6607-4277-bcb3-255155a768a4">creating the env to reproduce the issue</a>
<ul>
<li><a href="#bce29f4d-e717-41be-bf0d-0e634be8a9be">the network</a></li>
<li><a href="#16895f3b-0df7-44a8-a43b-626ac6cd2f57">the containers</a></li>
<li><a href="#3b1edd42-992c-4114-8614-1f153fb23fe3">nginx</a></li>
</ul>
</li>
<li><a href="#a2d23ddb-2b7c-4406-a089-8094f1884ad7">using resolver with a validity period</a></li>
<li><a href="#0b458c0c-d4f7-435e-b3d0-cc7d2b96e314">with the backend as a variable</a></li>
<li><a href="#c6edeae9-ccb2-439c-838e-82f294ef295e">using upstream and resolve</a></li>
<li><a href="#e9f5e539-efaa-4480-8153-231e2c11159d">in kubernetes</a></li>
<li><a href="#permalink">Permalink</a></li>
</ul>
</div>
<!--endtoc-->
<p>Context: I was debugging an issue with <a href="/braindump/posts/nginx/">nginx</a> behind in front of a ECS load
balancer. The load balancer was recreated. Its dns record updated, but nginx
failed to fetch the new ip address.</p>
<p>There are plenty of stack overflow discussion about using the <code>resolver</code>
instruction and even the documentation is quite explicit about it. I was
surprised to realize how it worked.</p>
<h2 id="a22baef3-6607-4277-bcb3-255155a768a4">creating the env to reproduce the issue</h2>
<h3 id="bce29f4d-e717-41be-bf0d-0e634be8a9be">the network</h3>
<p>I will take advantage of the internal dns of docker to simulate the moving
dns entry.</p>
<p>As per the documentation of docker, the docker bridge network <a href="/braindump/posts/docker/#ec1a86a0-cdc9-4b6a-8b13-597b2afdc8d9">cannot resolve dns names</a>.</p>
<p>Let&rsquo;s create our own.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker network create <span style="color:#0086b3">test</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>3e8c801c300fb53fe2f9962a53f4263357a37231557e9bceee01b8d595291ebc
</span></span></code></pre></div><h3 id="16895f3b-0df7-44a8-a43b-626ac6cd2f57">the containers</h3>
<p>Then, let&rsquo;s run a simple http service in that network.</p>
<p><a id="code-snippet--service"></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -ti --detach --network <span style="color:#0086b3">test</span> --name service traefik/whoami
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>8c6766257ec39b4268e91c4af60dc9053b6fe1fffe4a4a61952fbc6691931648
</span></span></code></pre></div><p>Then, let&rsquo;s ping it to see its ip address</p>
<p><a id="code-snippet--ping"></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm --network <span style="color:#0086b3">test</span> alpine ping -c <span style="color:#099">1</span> service.test
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>PING service.test (172.18.0.2): 56 data bytes
</span></span><span style="display:flex;"><span>64 bytes from 172.18.0.2: seq=0 ttl=64 time=0.099 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- service.test ping statistics ---
</span></span><span style="display:flex;"><span>1 packets transmitted, 1 packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max = 0.099/0.099/0.099 ms
</span></span></code></pre></div><p>Now, let&rsquo;s kill it and add a dummy sleep container to have another ip address.</p>
<p><a id="code-snippet--sleep"></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm -ti --detach --name sleep --network <span style="color:#0086b3">test</span> alpine sleep <span style="color:#099">3600</span>
</span></span></code></pre></div><p><a id="code-snippet--to4"></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Using ip != 2&#34;</span>
</span></span><span style="display:flex;"><span>docker <span style="color:#0086b3">kill</span> service
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --name sleep --network <span style="color:#0086b3">test</span> alpine sleep <span style="color:#099">3600</span>
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --network <span style="color:#0086b3">test</span> --name service traefik/whoami
</span></span><span style="display:flex;"><span>docker run --rm --network <span style="color:#0086b3">test</span> alpine ping -c <span style="color:#099">1</span> service.test
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Using ip != 2
</span></span><span style="display:flex;"><span>service
</span></span><span style="display:flex;"><span>e2cba3c3478549287915bc2cfbeb79c828ed89e52f2083d5967469bf4ff3c4ff
</span></span><span style="display:flex;"><span>PING service.test (172.18.0.3): 56 data bytes
</span></span><span style="display:flex;"><span>64 bytes from 172.18.0.3: seq=0 ttl=64 time=0.235 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- service.test ping statistics ---
</span></span><span style="display:flex;"><span>1 packets transmitted, 1 packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max = 0.235/0.235/0.235 ms
</span></span></code></pre></div><p>To go back to the ip 2, it suffices to kill both and simply restart the
service.</p>
<p><a id="code-snippet--to2"></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;Going back to ip 2&#34;</span>
</span></span><span style="display:flex;"><span>docker <span style="color:#0086b3">kill</span> service sleep
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --network <span style="color:#0086b3">test</span> --name service traefik/whoami
</span></span><span style="display:flex;"><span>docker run --rm --network <span style="color:#0086b3">test</span> alpine ping -c <span style="color:#099">1</span> service.test
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Going back to ip 2
</span></span><span style="display:flex;"><span>service
</span></span><span style="display:flex;"><span>sleep
</span></span><span style="display:flex;"><span>4d4eaab4b33d9bdd7ccc975a867d391afe4189ea74ede7b8f4986d46232b0e97
</span></span><span style="display:flex;"><span>PING service.test (172.18.0.2): 56 data bytes
</span></span><span style="display:flex;"><span>64 bytes from 172.18.0.2: seq=0 ttl=64 time=0.168 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- service.test ping statistics ---
</span></span><span style="display:flex;"><span>1 packets transmitted, 1 packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max = 0.168/0.168/0.168 ms
</span></span></code></pre></div><h3 id="3b1edd42-992c-4114-8614-1f153fb23fe3">nginx</h3>
<p>Now, let&rsquo;s start a nginx container to proxy connections to the service.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#d14">&lt;&lt;EOF &gt; /tmp/proxy_pass.conf
</span></span></span><span style="display:flex;"><span><span style="color:#d14">server {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    server_name _;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    location / {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        proxy_pass http://service.test;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --name nginx --network <span style="color:#0086b3">test</span> --publish 8080:80 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --volume /tmp/proxy_pass.conf:/etc/nginx/conf.d/default.conf <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>f19b2d312a93b69fffc0fb62129806617fafb085ebacf88c75f2b04c159d8c42
</span></span></code></pre></div><p>And try it</p>
<p><a id="code-snippet--curl"></a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl localhost:8080/
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hostname: 4d4eaab4b33d
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: ::1
</span></span><span style="display:flex;"><span>IP: 172.18.0.2
</span></span><span style="display:flex;"><span>RemoteAddr: 172.18.0.3:37966
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: service.test
</span></span><span style="display:flex;"><span>User-Agent: curl/8.10.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Connection: close
</span></span></code></pre></div><p>Great. We have access to the service, on the ip 2.</p>
<p>Let&rsquo;s move the service container to another ip address.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Using ip != 2
</span></span><span style="display:flex;"><span>service
</span></span><span style="display:flex;"><span>9b7a6eb3c83fe853ad4c1837573017e92314b48f225b1cf09aeda7a469dd2739
</span></span><span style="display:flex;"><span>e22c6c1d25fbcc9e81a883726ede70cc93d0c807c18a302e5137a06ca17d3de1
</span></span><span style="display:flex;"><span>PING service.test (172.18.0.4): 56 data bytes
</span></span><span style="display:flex;"><span>64 bytes from 172.18.0.4: seq=0 ttl=64 time=0.264 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- service.test ping statistics ---
</span></span><span style="display:flex;"><span>1 packets transmitted, 1 packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max = 0.264/0.264/0.264 ms
</span></span></code></pre></div><p>And try again to curl nginx.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt;
</span></span><span style="display:flex;"><span>&lt;hr&gt;&lt;center&gt;nginx/1.27.4&lt;/center&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div><p>This is the issue we are studying.</p>
<h2 id="a2d23ddb-2b7c-4406-a089-8094f1884ad7">using resolver with a validity period</h2>
<p>According to the <a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#resolver">documentation</a>, we could add a <code>resolver</code> entry to nginx location.</p>
<p>We can see the ip of the dns server in /etc/resolv.conf.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --rm --network <span style="color:#0086b3">test</span> alpine cat /etc/resolv.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># Generated by Docker Engine.
</span></span><span style="display:flex;"><span># This file can be edited; Docker Engine will not make further changes once it
</span></span><span style="display:flex;"><span># has been modified.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nameserver 127.0.0.11
</span></span><span style="display:flex;"><span>options ndots:0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Based on host file: &#39;/etc/resolv.conf&#39; (internal resolver)
</span></span><span style="display:flex;"><span># ExtServers: [192.168.1.1]
</span></span><span style="display:flex;"><span># Overrides: []
</span></span><span style="display:flex;"><span># Option ndots from: internal
</span></span></code></pre></div><p>Let&rsquo;s make use of it in our nginx instance.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker <span style="color:#0086b3">kill</span> nginx
</span></span><span style="display:flex;"><span>cat <span style="color:#d14">&lt;&lt;EOF &gt; /tmp/proxy_pass.conf
</span></span></span><span style="display:flex;"><span><span style="color:#d14">server {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    server_name _;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    location / {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        resolver 127.0.0.11 valid=2s;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        proxy_pass http://service.test;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --name nginx --network <span style="color:#0086b3">test</span> --publish 8080:80 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --volume /tmp/proxy_pass.conf:/etc/nginx/conf.d/default.conf <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>nginx
</span></span><span style="display:flex;"><span>1ccae4b4cf250f92d5695aaf7a284afad97f5fae8d51b4746acf2c7f3216e07c
</span></span></code></pre></div><p>Now, let&rsquo;s see it first work ok.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hostname: e22c6c1d25fb
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: ::1
</span></span><span style="display:flex;"><span>IP: 172.18.0.4
</span></span><span style="display:flex;"><span>RemoteAddr: 172.18.0.3:46086
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: service.test
</span></span><span style="display:flex;"><span>User-Agent: curl/8.10.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Connection: close
</span></span></code></pre></div><p>Then, move it back to the ip address 2.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Going back to ip 2
</span></span><span style="display:flex;"><span>service
</span></span><span style="display:flex;"><span>sleep
</span></span><span style="display:flex;"><span>66d053baac2412eeb01f984df300381c4244bfa85ee6bfb122509b6e0e97f786
</span></span><span style="display:flex;"><span>PING service.test (172.18.0.2): 56 data bytes
</span></span><span style="display:flex;"><span>64 bytes from 172.18.0.2: seq=0 ttl=64 time=0.094 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- service.test ping statistics ---
</span></span><span style="display:flex;"><span>1 packets transmitted, 1 packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max = 0.094/0.094/0.094 ms
</span></span></code></pre></div><p>Now, trying again</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt;
</span></span><span style="display:flex;"><span>&lt;hr&gt;&lt;center&gt;nginx/1.27.4&lt;/center&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div><p>This is not good.</p>
<p>Actually, the resolver is not taken into account, as we can see by restarting
nginx with a dumb resolver.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker <span style="color:#0086b3">kill</span> nginx
</span></span><span style="display:flex;"><span>cat <span style="color:#d14">&lt;&lt;EOF &gt; /tmp/proxy_pass.conf
</span></span></span><span style="display:flex;"><span><span style="color:#d14">server {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    server_name _;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    location / {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        resolver 1.2.3.4 valid=2s;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        proxy_pass http://service.test;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --name nginx --network <span style="color:#0086b3">test</span> --publish 8080:80 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --volume /tmp/proxy_pass.conf:/etc/nginx/conf.d/default.conf <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>nginx
</span></span><span style="display:flex;"><span>d99097278e186c560a9c453ba68adb19e9b18a235e56ba24806b2958aa1ee6a9
</span></span></code></pre></div><p>Then, try it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hostname: 66d053baac24
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: ::1
</span></span><span style="display:flex;"><span>IP: 172.18.0.2
</span></span><span style="display:flex;"><span>RemoteAddr: 172.18.0.3:42612
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: service.test
</span></span><span style="display:flex;"><span>User-Agent: curl/8.10.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Connection: close
</span></span></code></pre></div><p>While it should have failed to use the ip 1.2.3.4.</p>
<h2 id="0b458c0c-d4f7-435e-b3d0-cc7d2b96e314">with the backend as a variable</h2>
<p>I read somewhere that using a variable helped.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker <span style="color:#0086b3">kill</span> nginx
</span></span><span style="display:flex;"><span>cat &lt;&lt;<span style="color:#d14">&#34;EOF&#34;</span> &gt; /tmp/proxy_pass.conf
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen 80;
</span></span><span style="display:flex;"><span>    server_name _;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        resolver 127.0.0.11 <span style="color:#008080">valid</span><span style="color:#000;font-weight:bold">=</span>2s;
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">set</span> <span style="color:#008080">$backend</span> <span style="color:#d14">&#34;http://service.test&#34;</span>;
</span></span><span style="display:flex;"><span>        proxy_pass <span style="color:#008080">$backend</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --name nginx --network <span style="color:#0086b3">test</span> --publish 8080:80 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --volume /tmp/proxy_pass.conf:/etc/nginx/conf.d/default.conf <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>nginx
</span></span><span style="display:flex;"><span>5dc5c585dfb04a357c16ae6772587608230aeb82b592d44b4cb49f57de57b03a
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hostname: 66d053baac24
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: ::1
</span></span><span style="display:flex;"><span>IP: 172.18.0.2
</span></span><span style="display:flex;"><span>RemoteAddr: 172.18.0.3:46830
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: service.test
</span></span><span style="display:flex;"><span>User-Agent: curl/8.10.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Connection: close
</span></span></code></pre></div><p>Now, going to another ip address.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Using ip != 2
</span></span><span style="display:flex;"><span>service
</span></span><span style="display:flex;"><span>02b42d79c381e676eb74a6fb0cbe859d7b3ba898ac1c3dc020334d1d89ab967f
</span></span><span style="display:flex;"><span>a1163e6d4131a3d3a855ced05e687883333d3d237b8f219a779298484682b999
</span></span><span style="display:flex;"><span>PING service.test (172.18.0.4): 56 data bytes
</span></span><span style="display:flex;"><span>64 bytes from 172.18.0.4: seq=0 ttl=64 time=0.108 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- service.test ping statistics ---
</span></span><span style="display:flex;"><span>1 packets transmitted, 1 packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max = 0.108/0.108/0.108 ms
</span></span></code></pre></div><p>And trying again</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hostname: a1163e6d4131
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: ::1
</span></span><span style="display:flex;"><span>IP: 172.18.0.4
</span></span><span style="display:flex;"><span>RemoteAddr: 172.18.0.3:38646
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: service.test
</span></span><span style="display:flex;"><span>User-Agent: curl/8.10.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Connection: close
</span></span></code></pre></div><p>We indeed realize that this made the nginx program react to the change in the
dns record.</p>
<p>Also, trying to use a dumb resolver, it fails, showing that it actually uses it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker <span style="color:#0086b3">kill</span> nginx
</span></span><span style="display:flex;"><span>cat &lt;&lt;<span style="color:#d14">&#34;EOF&#34;</span> &gt; /tmp/proxy_pass.conf
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen 80;
</span></span><span style="display:flex;"><span>    server_name _;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        resolver 1.2.3.4 <span style="color:#008080">valid</span><span style="color:#000;font-weight:bold">=</span>2s;
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">set</span> <span style="color:#008080">$backend</span> <span style="color:#d14">&#34;http://service.test&#34;</span>;
</span></span><span style="display:flex;"><span>        proxy_pass <span style="color:#008080">$backend</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --name nginx --network <span style="color:#0086b3">test</span> --publish 8080:80 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --volume /tmp/proxy_pass.conf:/etc/nginx/conf.d/default.conf <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>nginx
</span></span><span style="display:flex;"><span>c4d79e495af0f585a0f3be672dfeef28b17ad62ec559d28310ddaaed3740d738
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt;
</span></span><span style="display:flex;"><span>&lt;hr&gt;&lt;center&gt;nginx/1.27.4&lt;/center&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div><p>But unfortunately, it ignores the value of the <code>valid</code> field.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker <span style="color:#0086b3">kill</span> nginx
</span></span><span style="display:flex;"><span>cat &lt;&lt;<span style="color:#d14">&#34;EOF&#34;</span> &gt; /tmp/proxy_pass.conf
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen 80;
</span></span><span style="display:flex;"><span>    server_name _;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        resolver 127.0.0.11 <span style="color:#008080">valid</span><span style="color:#000;font-weight:bold">=</span>3600s;
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">set</span> <span style="color:#008080">$backend</span> <span style="color:#d14">&#34;http://service.test&#34;</span>;
</span></span><span style="display:flex;"><span>        proxy_pass <span style="color:#008080">$backend</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --name nginx --network <span style="color:#0086b3">test</span> --publish 8080:80 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --volume /tmp/proxy_pass.conf:/etc/nginx/conf.d/default.conf <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>nginx
</span></span><span style="display:flex;"><span>c7e069440db400a7200c2df2e23070f63522affac7177f03e73ba8b861903121
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hostname: a1163e6d4131
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: ::1
</span></span><span style="display:flex;"><span>IP: 172.18.0.4
</span></span><span style="display:flex;"><span>RemoteAddr: 172.18.0.3:53524
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: service.test
</span></span><span style="display:flex;"><span>User-Agent: curl/8.10.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Connection: close
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Going back to ip 2
</span></span><span style="display:flex;"><span>service
</span></span><span style="display:flex;"><span>sleep
</span></span><span style="display:flex;"><span>541f00945d87e5430ccd90328a705e16ec737fb436bf778863ab5ec3bbd3b33e
</span></span><span style="display:flex;"><span>PING service.test (172.18.0.2): 56 data bytes
</span></span><span style="display:flex;"><span>64 bytes from 172.18.0.2: seq=0 ttl=64 time=0.276 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- service.test ping statistics ---
</span></span><span style="display:flex;"><span>1 packets transmitted, 1 packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max = 0.276/0.276/0.276 ms
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hostname: 541f00945d87
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: ::1
</span></span><span style="display:flex;"><span>IP: 172.18.0.2
</span></span><span style="display:flex;"><span>RemoteAddr: 172.18.0.3:60376
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: service.test
</span></span><span style="display:flex;"><span>User-Agent: curl/8.10.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Connection: close
</span></span></code></pre></div><p>I would have expected it to fail because it took me less than 3600s to run
those and the ip address should have remained the same.</p>
<p>In real life, with ECS, it looked like it followed the TTL of the record. In
this simulation, it appears it is immediate. I don&rsquo;t know why.</p>
<h2 id="c6edeae9-ccb2-439c-838e-82f294ef295e">using upstream and resolve</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker <span style="color:#0086b3">kill</span> nginx
</span></span><span style="display:flex;"><span>cat <span style="color:#d14">&lt;&lt;EOF &gt; /tmp/proxy_pass.conf
</span></span></span><span style="display:flex;"><span><span style="color:#d14">resolver 127.0.0.11 valid=3600s;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">server {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    server_name _;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    location / {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        proxy_pass http://backend;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">upstream backend {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">   # I don&#39;t know what this zone means, but it complains if it&#39;s not there
</span></span></span><span style="display:flex;"><span><span style="color:#d14">   zone backend 64k;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">   server service.test   resolve;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --name nginx --network <span style="color:#0086b3">test</span> --publish 8080:80 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --volume /tmp/proxy_pass.conf:/etc/nginx/conf.d/default.conf <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>nginx
</span></span><span style="display:flex;"><span>6e35209940ce6d1a46735d61d62e4049ab669613e1df87d779cb7feefb965e25
</span></span></code></pre></div><p>I can still resolve to the service.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hostname: 541f00945d87
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: ::1
</span></span><span style="display:flex;"><span>IP: 172.18.0.2
</span></span><span style="display:flex;"><span>RemoteAddr: 172.18.0.3:33520
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: backend
</span></span><span style="display:flex;"><span>User-Agent: curl/8.10.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Connection: close
</span></span></code></pre></div><p>And using another ip address before the validity expiration indeed gets a 502
error.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Using ip != 2
</span></span><span style="display:flex;"><span>service
</span></span><span style="display:flex;"><span>05e64556aa84144076a0a3c489841d848f629a87ab5ebd453955f6236fa17646
</span></span><span style="display:flex;"><span>ff1554068d09ce633d0c3ba7813836a8774072eed6c7ebddc1c3c95158934cff
</span></span><span style="display:flex;"><span>PING service.test (172.18.0.4): 56 data bytes
</span></span><span style="display:flex;"><span>64 bytes from 172.18.0.4: seq=0 ttl=64 time=0.545 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- service.test ping statistics ---
</span></span><span style="display:flex;"><span>1 packets transmitted, 1 packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max = 0.545/0.545/0.545 ms
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt;
</span></span><span style="display:flex;"><span>&lt;hr&gt;&lt;center&gt;nginx/1.27.4&lt;/center&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div><p>Let&rsquo;s now try it with a shorter validity period.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker <span style="color:#0086b3">kill</span> nginx
</span></span><span style="display:flex;"><span>cat <span style="color:#d14">&lt;&lt;EOF &gt; /tmp/proxy_pass.conf
</span></span></span><span style="display:flex;"><span><span style="color:#d14">resolver 127.0.0.11 valid=2s;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">server {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    listen 80;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    server_name _;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    location / {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">        proxy_pass http://backend;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">    }
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">
</span></span></span><span style="display:flex;"><span><span style="color:#d14">upstream backend {
</span></span></span><span style="display:flex;"><span><span style="color:#d14">   # I don&#39;t know what this zone means, but it complains if it&#39;s not there
</span></span></span><span style="display:flex;"><span><span style="color:#d14">   zone backend 64k;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">   server service.test   resolve;
</span></span></span><span style="display:flex;"><span><span style="color:#d14">}
</span></span></span><span style="display:flex;"><span><span style="color:#d14">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --rm -ti --detach --name nginx --network <span style="color:#0086b3">test</span> --publish 8080:80 <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       --volume /tmp/proxy_pass.conf:/etc/nginx/conf.d/default.conf <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>       nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>nginx
</span></span><span style="display:flex;"><span>66918d3258b7b9eb6c0f589e5f96d7280c6b2e49c50754209c54b90c240e81e7
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hostname: ff1554068d09
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: ::1
</span></span><span style="display:flex;"><span>IP: 172.18.0.4
</span></span><span style="display:flex;"><span>RemoteAddr: 172.18.0.3:58124
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: backend
</span></span><span style="display:flex;"><span>User-Agent: curl/8.10.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Connection: close
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Going back to ip 2
</span></span><span style="display:flex;"><span>service
</span></span><span style="display:flex;"><span>sleep
</span></span><span style="display:flex;"><span>7ffe6737eab0917d4da9225d77e85295356574b936635f62547117525b9d69e4
</span></span><span style="display:flex;"><span>PING service.test (172.18.0.2): 56 data bytes
</span></span><span style="display:flex;"><span>64 bytes from 172.18.0.2: seq=0 ttl=64 time=0.089 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- service.test ping statistics ---
</span></span><span style="display:flex;"><span>1 packets transmitted, 1 packets received, 0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max = 0.089/0.089/0.089 ms
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Hostname: 7ffe6737eab0
</span></span><span style="display:flex;"><span>IP: 127.0.0.1
</span></span><span style="display:flex;"><span>IP: ::1
</span></span><span style="display:flex;"><span>IP: 172.18.0.2
</span></span><span style="display:flex;"><span>RemoteAddr: 172.18.0.3:42180
</span></span><span style="display:flex;"><span>GET / HTTP/1.1
</span></span><span style="display:flex;"><span>Host: backend
</span></span><span style="display:flex;"><span>User-Agent: curl/8.10.1
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Connection: close
</span></span></code></pre></div><p>This behaves exactly as intended. That&rsquo;s a relief.</p>
<h2 id="e9f5e539-efaa-4480-8153-231e2c11159d">in <a href="/braindump/posts/kubernetes/">kubernetes</a></h2>
<blockquote>
<p>In a standard cluster the IP in resolv.conf belongs to kube-dns.kube-system.svc.cluster.local. So it is better to use that instead.</p>
<p>&mdash; <a href="https://serverfault.com/questions/876308/kubernetes-dns-resolver-in-nginx">https://serverfault.com/questions/876308/kubernetes-dns-resolver-in-nginx</a> (<span class="timestamp-wrapper"><span class="timestamp">[2025-03-21 Fri]</span></span>)</p>
</blockquote>
<h2 id="permalink"><a href="https://konubinix.eu/braindump/28a6ad44-67bb-4674-99be-8841900f9184?title=beware_the_resolver_of_nginx">Permalink</a></h2>
      </div>
	  <aside class="date"><time>Last updated: 21 Mar 2025</time></aside>
	  <aside class="date"><time>Published&nbsp;&nbsp;&nbsp;: 04 Mar 2025</time></aside>
    </div>
  </div>
</div>

<script src="/braindump/js/URI.js" type="text/javascript"></script>

<script src="/braindump/js/page.js" type="text/javascript"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>
